<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="/assets/article/course.css?v=2023122609">
    <style>
        .timestamp {
            font-weight: 500;
            color: #2E4E6F;
            text-decoration: underline;
        }
    </style>
    </head>
<body class="">

<div class="btn-group boxFAQ" id="questionMarkId" style="display: none;">
    <!--button class="copy">复制</button>
    <button class="line">划线</button>
    <button class="delete" style="display: none;">删除</button>
    <button class="note">添加笔记</button>
    <button class="check-note" style="display: none;">查看笔记</button-->
<!--  -->
    <div class="cancel-excerpt btn-group-item"><div class="cancel-excerpt-icon"></div><div class="group-btn-text">删除摘录</div></div>
    <div class="excerpt btn-group-item"><div class="excerpt-icon"></div><div class="group-btn-text">摘录</div></div>
    <div class="btn-note new-note btn-group-item"><div class="new-note-icon"></div><div class="group-btn-text">写笔记</div></div>
    <div class="btn-note edit-note btn-group-item"><div class="edit-note-icon"></div><div class="group-btn-text">编辑笔记</div></div>
    <div class="share btn-group-item"><div class="share-icon"></div><div class="group-btn-text">分享</div></div>
    <div class="copy btn-group-item"> <div class="copy-icon"></div><div  class="group-btn-text">复制</div></div>
</div>

<textarea id="popoverMarkId" readonly rows="3" maxlength="8" style="display: none;"></textarea>

<div class="course   small">
    <div class="course-content">
                                    <div>你好，欢迎收听《从中国出发的全球史》，我是段志强。</div>
<h4 class="article-h4">刺激感官的瘾品</h4>
<div>前面我们讲辣椒传播到世界各地之后，改变了很多人的口味。有的人吃辣，就是图个爽。辣椒之类，那是刺激味觉，其实还有别的感官刺激：耳朵听音乐，眼睛看电视、电影、视频，这是比较温和的；</div>
<div>抽烟、喝酒、喝咖啡、喝茶、吃巧克力、嚼槟榔，这就更刺激一些；大麻、古柯叶、鸦片，以及其他的各种毒品，那就刺激得过了头。</div>
<div>这里面有些古代人也玩过，比如说就在前几天，中国科学院大学的研究人员发表了一篇论文，说他们发现了世界上最早的吸大麻的考古证据，应该跟宗教有关系，时代是在2500年前。那是在新疆的塔什库尔干，中国最西边的一个县，这个遗址我还去过。</div>
<div>不过，跟古代人比起来，现代人在刺激感官的手段上要丰富得多。老子说，&ldquo;五色令人目盲，五音令人耳聋，五味令人口爽&rdquo;，现代人的感官刺激早就超过了老子的想象。</div>
<div>这些刺激的东西都不是生活必需品，但是人却很容易对它们形成依赖。依赖的原因，当然一方面是生理上的，但更重要的，这些瘾品&mdash;&mdash;上瘾的瘾，很多时候其实是帮助社交的，比如喝酒，喝咖啡，抽大麻，都一样。很多人之所以会形成一些嗜好，最开始的动力往往是社交。</div>
<div>这些社交催化剂里面，除了酒是多个地方的人分别发明的之外，其他都是从一个地方起源、最后却传播到全世界的。比如茶原产中国，本来流传在东亚，工业革命以后逐渐传播到全世界；</div>
<div>咖啡产在埃塞俄比亚，被阿拉伯人带到了全世界；可可树原产南美，1544年一个多米尼加的玛雅代表团访问了西班牙，他们带了用可可做的热饮，引起欧洲人的兴趣，这才发明了固体巧克力等等。</div>
<div>后面我们有会有专门的章节来讲茶和鸦片的贸易史，因为那牵扯到很多沉重的政治和经济话题，今天我们先说说烟草。</div>
<h4 class="article-h4">包治百病的灵丹妙药</h4>
<div>烟草跟土豆、辣椒、西红柿这些美洲作物一样，都属于茄科植物，说起来都是亲戚。只不过龙生九种，种种不同，这几种作物的区别已经非常大了。</div>
<div>世界上最早种植烟草的地区，是在南美洲玻利维亚到阿根廷一带的山地，比土豆和辣椒的起源地稍微靠南一点。就目前的考古证据来看，人类吸烟的历史并不长，最早的吸烟场景是公元432年的一块浮雕。</div>
<div><img class="upload" src="http://cdn.vistopia.com.cn/1562779950461.png" alt="" width="292" height="500" /></div>
<div class="img-info" style="text-align: center;">玛雅人吸烟的浮雕</div>
<div>这块浮雕表现的是某种仪式上的玛雅人在吸烟。烟草的功能是造成神经亢奋，而且吸烟的时候烟雾缭绕，也显得神秘兮兮，还感觉飘飘然如神仙之概，所以美洲土著往往是在宗教仪式上使用烟草，等于人神沟通的桥梁，浮雕上吸烟的这个人应该是位祭司。</div>
<div>哥伦布说，美洲土著的酋长和祭司，有时候甚至会吸烟吸到昏厥，真是好大的烟瘾。不过普通人一般不吸烟，他们嚼烟，把烟草叶子丢到嘴里嚼一嚼，效果也差不多，就只是没有喷雾的特效嘛。</div>
<div>之前我们说美洲土著看到西班牙人骑马都被震惊了，旧世界的人，头一次看到美洲人吸烟，也吓坏了。</div>
<div>那时哥伦布的船队在加勒比海的岛屿上停靠，船队里有两个人看见有个美洲土著，这个土著一手拿着燃烧的棍子，另一手拿着一个长管子，他的嘴里和鼻子里都喷出烟来，这两个人就吓得目瞪口呆。后来他们才知道那是玉米叶子裹着烟叶做成的香烟。</div>
<div>哥伦布本人对这个东西不太感兴趣，不过他船队里很快就有人染上了烟瘾。这些旧世界里面第一批烟民回到欧洲之后，当众表演吞云吐雾，欧洲人一度认为他们这是在跟魔鬼沟通。当然，从烟草对人类健康的危害来说，这样想好像也没错。</div>
<div>不过，人类认识到吸烟有害健康已经到了19世纪，欧洲人很长一段时间都觉得烟草不但可以提神解乏，而且能治病，甚至是包治百病的灵丹妙药。1560年，法国驻葡萄牙的大使尼古特，就把烟草献给了当时的法国皇太后凯瑟琳，治好了凯瑟琳的头疼病。</div>
<div>烟草中刺激神经的那个生物碱叫尼古丁，这个尼古丁就是根据尼古特的名字命名的。也就是在这之后，烟草被海上航行的西班牙和葡萄牙水手带到了非洲和亚洲，成了时髦的消费品。</div>
<div>烟草跟土豆、玉米之类不太一样，它对种植环境的要求比较高，所以一开始比较昂贵。17世纪美洲和非洲都开辟了烟草种植园，价格才降下来，像美国的弗吉尼亚，就是靠种植烟草才繁荣起来的。后来烤烟、卷烟发明出来，烟草也就越来越普及了。</div>
<h4 class="article-h4">烟草在中国的传播</h4>
<div>烟草传入中国的途径和时间，跟其他美洲作物都差不太多，我们前面提到过引种红薯的陈振龙，有一种说法是他从菲律宾带回了烟草种子种在福建漳州，结果产量很好，生产的烟叶反而可以卖回到菲律宾，赚了大钱。也有人说，明末的时候，福建就连小孩子都抽烟。</div>
<div>总之，大概在明代后期，烟草已经在中国很流传了。历史学界认为，烟草是通过三个途径传入中国的，一是由葡萄牙人从巴西经澳门，二是由西班牙人从墨西哥经马尼拉，三是&ldquo;辗转经东亚数地进入北京&rdquo;，这第三条道路也包括经由日本、朝鲜到达中国东北。</div>
<div>十六世纪末，大概在天启年间，北京开始有人抽烟，甚至引起了崇祯皇帝的不满，因为当时的农民种烟叶却不种粮食，这就危及朝廷根本了。不过，和土豆、辣椒这些不一样的是，烟草在中国的传播有另一个重要的途径，那就是通过军队。</div>
<div>明朝人说，漳州、泉州的烟草，后来传到了九边，就是明朝北方沿长城的九个军事重镇，包括大同、银川、固原这些地方。1627年，也就是天启末年，朝廷调广东兵到北方，烟草也随之北传。</div>
<div>据说，明代后期在云南用兵的时候，有很多人适应不了山区气候，生病，只有一个营的人安然无恙，一问，发现这个营的兵都吸烟，于是全军就都开始吸烟，吸烟和烟草也就传到了西南。</div>
<div><img class="upload" src="http://cdn.vistopia.com.cn/1562780022402.png" alt="" width="1080" height="937" /></div>
<div class="img-info" style="text-align: center;">烟草在中国的传播示意图，共三条路线，还刻意标注了明代的九边</div>
<div>明朝士兵的烟瘾到了什么程度呢？1637年崇祯皇帝要禁烟，规定私自种烟卖烟的人一律砍头，结果负责辽东防务的洪承畴跳出来反对，他反对的理由是什么？就是说，我的士兵都嗜烟如命，一旦禁烟，肯定大大打击士气，还是算了吧，崇祯皇帝只好不了了之。</div>
<div>崇祯这边是这样，他们的对手呢，在山海关外刚刚建立的大清朝也好不到哪儿去。皇太极雄才大略，本来他是很认真的禁烟的，因为东北的烟草大部分都是从朝鲜贩卖来的，非常的贵，而且完全是消耗品，但是禁而不止。</div>
<div>后来没办法，就妥协，改成自己种的可以吸，但是到朝鲜买的不行。到了最后连皇太极自己也说，唉，吸烟也不算什么大事，算了，算了，以后不管了。</div>
<div>皇太极禁烟的事，朝鲜的史料里面有很多记载。1638年，有朝鲜人走私了一批烟草到沈阳，被清朝将领发觉，引起很大的争端。朝鲜人管烟草叫&ldquo;南灵草&rdquo;或&ldquo;南草&rdquo;，说是日本所产，日本还生产各种精致的烟具，1620年代以后，逐渐在朝鲜流行，这条传播路线的烟草，中文名字叫南灵草。</div>
<div>但是从菲律宾到东南沿海进入中国的烟草，它的中文名字更多地叫淡巴菰，就是tobacco。Tobacco这个词哪儿来的呢？这是哥伦布听印第安人说的，其实这个名字指的是吸烟的烟杆，本来说的并不是烟草本身。</div>
<div>进入清朝以后，吸烟习惯逐渐向上层蔓延，康熙皇帝本人虽然不大吸烟，但是对鼻烟和鼻烟壶很感兴趣。雍正乾隆时代的宫廷里面，就都制作了大批的鼻烟壶。美洲土著本来就会吸鼻烟，后来法国宫廷里流行的也是鼻烟，那当然就是全欧洲追捧的时尚啦。康熙皇帝接触到的鼻烟也是欧洲传教士带来的。</div>
<div><img class="upload" src="http://cdn.vistopia.com.cn/1562780093973.png" alt="" width="293" height="466" /></div>
<div class="img-info" style="text-align: center;">清朝乾隆皇帝年间的瓷胎剔红八仙祝寿图鼻烟壶</div>
<div>当时大臣里面吸烟的很多，有名的纪晓岚纪大烟袋不用说了。有一回乾隆南巡，大臣们见驾之后躲在巡抚衙门的账房里吸烟，吞云吐雾，被乾隆看见了，好一顿骂。到了清末，就连慈禧太后和光绪皇帝也都吸烟，而且据说烟瘾还不小。</div>
<div>烟草的确有抚慰情绪的作用，常年在外辛劳的士兵、水手和商人用它来解压，那是很自然的事情。而且这些人脱离了家庭，很容易受到周围团体的影响，吸烟的习惯传播得非常快。</div>
<div>吸烟的社交功能也很快在东亚显现出来了。当时有朝鲜人说烟草&ldquo;对客辄代茶饮&rdquo;，在社交场合已经到了取代饮茶的地步。同样是社交工具，烟草比酒要简单得多，也便宜得多，随时随地，方便快捷。</div>
<div>敬烟的习惯跟吸烟的习惯一起流行，明清很多文献都说，客人来了要把自己的烟袋递给客人抽，还要装上自己的烟草，帮客人点着。我小时候还见过这种场景。清朝时候有人把烟草叫做&ldquo;干酒&rdquo;，像酒一样，但是它是干的，就是这个意思。</div>
<h4 class="article-h4">食物的历史，人的历史</h4>
<div>这就像依赖性的宗教信仰一样，烟草不只是个人消费习惯，也引起社会性的健康问题，现在已经成了人类社会的一个毛病。可是另一方面，据说它也能带来灵感，抚慰人心，又有很多人离不了它。</div>
<div>当然，烟草行业利润高，很多人从事这个行业，又形成很复杂的利益格局。比如说，现在中国最赚钱的公司，就是烟草总公司，一年的利润超过了一万亿，比四大银行加起来还要高很多。</div>
<div>当年日本打日俄战争，钱不够怎么办，就搞烟草专卖制度，一下子收上来很多钱，这才打赢了俄国。所以你看，新作物对世界的改变是非常深刻的。</div>
<div>好了，这五次节目我们谈了食物的全球史，今天就讲完了。我们谈到食物在全球范围内的传播，这是从基本需求的层面看到了人类的交流与沟通，食物的全球史是全球史的重要一环。</div>
<div>不过这只是比较表面的印象，其实吃什么、能吃多少、怎么获得这些食物，不仅是个人生计的问题，往往也决定着人类文明的性质和方向。每种食物都有它不同的特性，这些特性除了要问能、好、怎&mdash;&mdash;能吃吗，好吃吗，怎么吃&mdash;&mdash;之外，其实也跟社会有关，就像水稻方便征税、辣椒造福穷人、烟草适合军队一样，食物的历史，说到底还是人的历史。</div>
<div>食物的几集，我们就讲完了。前面这三个单元，我们讲了文明的诞生，讲了技术的发展，这几集我们又填饱了肚子，接下来该干什么了呢？接下来就该学点文化了吧。下一集我们来讲文字。</div>
<div>感谢收听，我们下集再见。</div>
<div class="img-info">撰稿： 段志强&nbsp; 讲述：段志强</div>
                                </div>
</div>
<script src="https://api.vistopia.com.cn/assets/libs/single_file/jquery.min.js"></script>
<script src="https://api.vistopia.com.cn/assets/libs/single_file/lodash.min.js"></script>
<script>
    // var vConsole = new VConsole();
    // 初始化变量
    var content_id="47";
    var article_id="143255";
    var user_data = [];
    var article_data = [];
    console.log("article_data:",article_data)

    var isProduction = true;
    var API_HOST = ""
    if(isProduction){
        API_HOST = "https://api.vistopia.com.cn"
    }else{
        API_HOST = "https://test-api.vistopia.com.cn"
    }
    
    var offsetLeft = 0;
    var prohibit = false;
    //是否试读
    var is_sample = false;
    console.log('is_sample: ',is_sample);

   
    //文稿是否截取 0:未截取；1：截取
    var is_cut_str = "0";
    //笔记记录（？）
    var _isNoteMenuVisable = false;
    var _isPopverMenuVisable = false;

    // 判断终端类型 ios/android 
    var deviceType = 'android';
    if(deviceType != 'android'){
        $('body').addClass("ios")
    }else{
        $('body').addClass("android")
    }
    console.log('location.href:',location.href)

    // 4.1.0笔记功能 start-----------------------------------------------------

    let isapp = window.navigator.userAgent.toLowerCase().indexOf('vistopia') !== -1; // 判断是否在端内（含iOS+安卓）
    //  判断版本号
    function GetVersion() {
        let u = navigator.userAgent;
        let version = "";
        if(isapp){
            if(deviceType != 'android'){
                version = u.match(/vistopia\/(\S*)\/ios/)[1];
            } else {
                version = u.match(/vistopia\/(\S*)\/android/)[1];
            }
        }
        
        return version
    };
    function version_check(baseVal) {
        let version = GetVersion()
        let list = [];
        let version_show = false
        if (version.indexOf(".")) {
        list = version.split(".");
        if (list[0] > baseVal[0]) {
            version_show = true;
        } else if (
            list[0] == baseVal[0] &&
            list[1] > baseVal[1]
        ) {
            version_show = true;
        } else if (
            list[0] == baseVal[0] &&
            list[1] == baseVal[1] &&
            list[2] >= baseVal[2]
        ) {
            version_show = true;
        } else {
            version_show = false;
        }
        } else {
        version_show = false;
        }
        return version_show
    }
    let version410 = version_check([4, 1, 0])
    console.log("version410:",version410)
    if(!isapp){
        version410 = true
    }
   
    // 获取链接上的参数
    function GetRequest() {
      var url = window.location.search; //获取url中"?"符后的字串
      var theRequest = new Object();
      if (url.indexOf("?") != -1) {
        var str = url.substr(1);
        var strs = str.split("&");
        for (var i = 0; i < strs.length; i++) {
          theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
        }
      }
      return theRequest;
    };
    
    // 获取链接上的token
    let api_token = GetRequest().api_token || GetRequest().base64_token || ""
    if(api_token){
        api_token  = window.atob(decodeURIComponent(api_token))
    }

    function getTimeStr(){
        // 获取当前时间
        let currentDate = new Date();
        // 获取年、月、日、时、分、秒
        let year = currentDate.getFullYear();
        let month = String(currentDate.getMonth() + 1).padStart(2, '0');
        let day = String(currentDate.getDate()).padStart(2, '0');
        let hours = String(currentDate.getHours()).padStart(2, '0');
        let minutes = String(currentDate.getMinutes()).padStart(2, '0');
        let seconds = String(currentDate.getSeconds()).padStart(2, '0');

        // 格式化为字符串
        let formattedDate = `${year}.${month}.${day} ${hours}:${minutes}:${seconds}`;
        return formattedDate;
    }
    
    //文稿笔记数据
    var note_data = []
    console.log('note_data:',note_data)
    let link_note_id = GetRequest().note_id || "" //链接上的note_id，从笔记详情跳入文稿页，需要定位到笔记的位置
    let link_note_position = 0 // 笔记位置
    let new_note_data = []//比对数据时，如果有索引变化，内容未变的情况，将这条数据放入新的数组中，并修改数据的索引
    let allNodeText = ''//所有正文内容
    let allNodeText_filter = ''//所有正文内容过滤掉空格和换行
    let note_data_index = 0
    let new_note_data_index = 0
    let remark_index = 0
    let remark_text = ""
    let remark_text_length = 0
    let note_type = ""
    let note_id = ""
    let note_content = ""
    let nodeLength = 0
    let target_node_list = []//获取到要与remark_text进行比对的节点数组。获取方法为：循环所有节点，找到划线索引所在的节点，从这个节点的划线索引位置的字符开始，向后统计长度为划线内容长度的字符，将这些字符所在的节点放入这个数组中
    let target_node_text = ""//target_node_list中的节点内容拼接起来的字符串
    let target_node_start = 0
    let node_compare_flag = true
    let latter_node_text = ""//划线内容横跨多个节点时，其在最后一个节点里对应的字符串
    let note_is_chosen = "0"
    let note_chosen_data = null;
    let note_chosen_data_click = null;
    let isSelecetNoteContent = true//选中文字后的弹窗是否有笔记、摘录功能
    let selection_cursor_s = 0 //选中文字时光标起始点所在节点距顶部的高度
    let selection_cursor_e = 0 //选中文字时光标结束点所在节点距顶部的高度
     
    if(version410){
        // note_data.sort((a, b) => parseInt(a.remark_index) - parseInt(b.remark_index));
        // 初始化设置节点方法
        initNote()
        // 处理原始笔记数据
         note_data.forEach(function(node,index) {
            // 初始化相关变量
            initVariable(note_data,index)
            //设置笔记/划线样式方法--获取目标节点
            getTargetNode('note_data',index)
        })
        // 处理因页面修改而出现变动的笔记数据
        console.log("new_note_data:",new_note_data)
        if(new_note_data.length>0){
            // new_note_data.sort((a, b) => parseInt(a.remark_index) - parseInt(b.remark_index));
            new_note_data.forEach(function(node,index) {
                initVariable(new_note_data,index)
                getTargetNode('new_note_data',index)
            })
        }
    }
   
    // 初始化设置节点方法
    function initNote(){
        //文稿正文根节点
        let rootElement = document.getElementsByClassName('course-content')[0];
        //获取正文html所有基本节点
        let baseNodes = getBasicNodes(rootElement);
        baseNodes.forEach(function(node,index) {
            // 给所有基本节点编号，添加data-index属性，属性值为序号值
            setBaseNodesIndexAttributes(node, index);
        })
        // console.log("allNodeText:",allNodeText)
    }
    function initVariable(data,data_index){
        remark_index = parseInt(data[data_index].remark_index)
        remark_text = data[data_index].remark_text
        remark_text_length = data[data_index].remark_text.length
        note_type = data[data_index].note_type
        note_id = data[data_index].note_id
        note_content = data[data_index].note_content
        nodeLength = 0
        target_node_list = []//获取到要与remark_text进行比对的节点数组。获取方法为：循环所有节点，找到划线索引所在的节点，从这个节点的划线索引位置的字符开始，向后统计长度为划线内容长度的字符，将这些字符所在的节点放入这个数组中
        target_node_text = ""//target_node_list中的节点内容拼接起来的字符串
        target_node_start = 0
        node_compare_flag = true
        latter_node_text = ""//划线内容横跨多个节点时，其在最后一个节点里对应的字符串
        // console.log("remark_index:",remark_index)
    }
    //设置笔记/划线样式方法--获取目标节点
    function getTargetNode(type,node_index){
        // 获取所有文本节点
        let baseTextList = $('.base-text').toArray()
        // console.log("baseTextList:",baseTextList)
        // 循环文本节点，获取划线内容首字符所在的节点--起始节点，从起始节点的索引位置开始，获取长度为划线内容长度的字符串，用这个字符串与划线内容比较
        for(let i=0;i<baseTextList.length;i++){
            if(node_compare_flag){
                // 累加节点中文本字符的长度
                let baseText_text = baseTextList[i].textContent || baseTextList[i].innerText
                nodeLength += baseText_text.length
                if(target_node_text == ""){//寻找起始节点
                    if(nodeLength >=remark_index){
                        console.log('=====================比对的'+type+'第'+(parseInt(node_index)+1)+'个数据:'+remark_text)
                        console.log('通过划线索引找到的起始节点：',baseTextList[i])
                        console.log('划线内容索引值:',remark_index)
                        // console.log('正文截止到起始节点（包含起始节点）的字符长度:',nodeLength)
                        // console.log('起始节点在全部文本节点数组中的排序序号:',i)
                        
                        target_node_start = remark_index - (nodeLength - baseText_text.length);//划线索引在起始节点中的位置，用累计的总的字符长度 - 这个节点的字符长度，得到之前所有节点的字符长度，用划线索引减去这个值，得到划线索引在这个节点所在的位置。
                        // console.log("target_node_start:",target_node_start)
                        target_node_text = baseText_text.substr(target_node_start-1);//提取起始节点的子字符串，长度为从划线索引值-1开始，到起始节点的末尾，比较子字符串长度与划线内容长度
                        
                        if(target_node_text.length >= remark_text_length){//如果子字符串长度大于等于划线内容长度，说明起始节点包含了全部的划线内容，直接处理起始节点
                            // target_node_text = baseTextList[i].innerText.substr(target_node_start-1,remark_text_length)//再提取一个新的起始节点的子字符串，长度为从索引值-1开始，长度为划线内容长度
                            node_compare_flag = false//此条数据比对结束，关闭循环
                            target_node_list.push(baseTextList[i])//将起始节点放入target_node_list数组中
                            console.log("target_node_text01:",i,target_node_text)
                             console.log("target_node_list01:",i,target_node_list)
                             //比对结束，处理target_node_list中的内容与划线内容，设置笔记/划线样式
                             handleNoteNode(remark_text, target_node_list, target_node_text, node_index)
                             break;
                            
                        }else{//划线内容超过了起始节点的范围，将起始节点存入target_node_list数组中，继续循环、比对后面的节点
                            target_node_text = baseText_text.substr(target_node_start-1);//如果节点后面的字符串长度小于划线内容长度，说明除了这个节点之外，划线内容还有一部分在后面的节点中，将节点内容从索引值之前截断，获取后面全部的字符，赋值给target_node_text，在后面的循环中不断累加字符赋值给target_node_text
                            target_node_list.push(baseTextList[i])//将起始节点放入target_node_list数组中
                        }
                                        
                    }
                }else{//划线内容超过了起始节点的范围，继续循环、比对后面的节点
                    let template_node_text = target_node_text + baseText_text
                    if(template_node_text.length >= remark_text_length){//到此节点为止，已覆盖全部的划线内容，将此节点存入target_node_list数组中
                        node_compare_flag = false//此条数据比对结束，关闭循环
                        latter_node_text = baseText_text.substr(0,remark_text_length-target_node_text.length)//划线内容横跨多个节点时，其在最后一个节点里对应的字符串。计算方法：划线内容全长 - 前面累计的节点内容的全长，得到剩余内容的长度，在此节点中从首字符开始，截取这个长度的内容。
                        target_node_text = target_node_text + latter_node_text//获取从索引值开始，长度为划线内容长度的字符串
                        target_node_list.push(baseTextList[i])
                        console.log("target_node_text02:",i,target_node_text)
                        console.log("target_node_list02:",i,target_node_list)
                        //此条数据比对结束，处理target_node_list中的内容与划线内容，设置笔记/划线样式
                        handleNoteNode(remark_text, target_node_list, target_node_text, node_index)
                        break;
                    }else{//到此节点为止，还没有覆盖全部的划线内容，将此节点存入target_node_list数组中，继续循环、比对后面的节点
                        target_node_text = target_node_text + baseText_text
                        target_node_list.push(baseTextList[i])
                    }
                }
                
            }
        }
        
    }
    //设置笔记/划线样式方法--比较目标节点内容和划线内容，是否符合匹配要求
    function handleNoteNode(remark_text,target_node_list,target_node_text,node_index){
        let start_index = target_node_start
        //划线内容全部在起始节点中
        if(target_node_list.length == 1){
            let node_text = target_node_list[0].textContent || target_node_list[0].innerText
            let node_remark_text = node_text.substr(start_index-1,remark_text_length)//提取起始节点的子字符串，从索引值位置开始，长度为划线内容长度。
            // 起始节点从索引值开始往后的内容完全包含划线内容，对子字符串node_text中与划线内容完全相同的部分设置属性；这里包含了两种情况：1）索引值没变，文字相同；（ 2）索引值变化（在这个节点的范围内变化），而文字相同；不能用这种方式，因为可能一个段落中还有多个相同的文本 ）
            if(node_text.substr(start_index-1, 1) == remark_text.substr(0,1) && node_text.substr(start_index-1).includes(remark_text)){
                setNoteAttribute(node_remark_text,target_node_list[0],start_index,'latter',target_node_list)
            //索引值未变（首字符相同），且子字符串node_remark_text与划线内容符合模糊匹配，对子字符串node_remark_text设置属性    
            }else if(node_text.substr(start_index-1, 1) == remark_text.substr(0,1) && compareStrings(node_remark_text,remark_text)){
                setNoteAttribute(node_remark_text,target_node_list[0],start_index,'latter',target_node_list)
            }else{//如果起始节点从索引值开始往后的内容与划线内容的首字符不相同，或子字符串与划线内容不合符模糊匹配
                //全文搜索是否有与划线内容相同的字符串
                if(allNodeText_filter.includes(remark_text.replace(/\s/g, ''))){
                    console.log("new_note_data::::::::",remark_text)
                    let note_data_temp = note_data[node_index]
                    // 将原始数据中的remark_index修正为新的索引
                    if(allNodeText.indexOf(remark_text)!=-1){
                        note_data[node_index].remark_index = allNodeText.indexOf(remark_text) + 1
                        note_data_temp.remark_index = allNodeText.indexOf(remark_text) + 1
                    }else{
                        note_data[node_index].remark_index = allNodeText_filter.indexOf(remark_text.replace(/\s/g, '')) + 1
                        note_data_temp.remark_index = allNodeText_filter.indexOf(remark_text.replace(/\s/g, '')) + 1
                    }
                    
                    // 将这条数据放入新数组new_note_data中
                    new_note_data.push(note_data_temp)
                }else{

                }
            }
        //划线内容跨越了多个节点，节点内容与划线内容比较，如果完全相同，或者首字符相同，且符合模糊匹配，就设置属性
        }else if(target_node_text == remark_text || (target_node_text.substr(0, 1) == remark_text.substr(0,1) && compareStrings(target_node_text,remark_text))){
            for(let i=0;i<target_node_list.length;i++){
                let node_text = target_node_list[i].textContent || target_node_list[i].innerText
                if(i == 0){//起始节点，获取子节点，从索引值开始，到节点最后，子节点设置属性
                    setNoteAttribute(node_text.substr(start_index-1),target_node_list[0],start_index,'latter',target_node_list)
                }else if(i< target_node_list.length-1){//中间节点，整个节点设置属性
                    setNoteAttribute(node_text,target_node_list[i],start_index,'all',target_node_list)
                }else{//结束节点，获取子节点，从起始开始，长度为latter_node_text的长度，子节点设置属性
                    setNoteAttribute(latter_node_text,target_node_list[i],start_index,'former',target_node_list)
                }
            }
        }else{
            //全文搜索是否有与划线内容相同的字符串
            if(allNodeText_filter.includes(remark_text.replace(/\s/g, ''))){
                console.log("new_note_data::::::::",remark_text)
                let note_data_temp = note_data[node_index]
                // 将原始数据中的remark_index修正为新的索引
                if(allNodeText.indexOf(remark_text)!=-1){
                    note_data[node_index].remark_index = allNodeText.indexOf(remark_text) + 1
                    note_data_temp.remark_index = allNodeText.indexOf(remark_text) + 1
                }else{
                    note_data[node_index].remark_index = allNodeText_filter.indexOf(remark_text.replace(/\s/g, '')) + 1
                    note_data_temp.remark_index = allNodeText_filter.indexOf(remark_text.replace(/\s/g, '')) + 1
                }
                // 将这条数据放入新数组new_note_data中
                new_note_data.push(note_data_temp)
            }else{
                
            }
        }
        
    }
    //设置笔记/划线样式方法--替换对应内容，设置属性
    function setNoteAttribute(noteText,noteNode,index,type,target_node_list){
        let noteNode_textContent = noteNode.textContent || noteNode.innerText
        // 链接上的note_id获取笔记在页面的高度传给端，滚动到这个笔记的位置
        if(link_note_id && link_note_id == note_id && (!link_note_position || link_note_position == 0)){
            link_note_position = target_node_list[0].offsetTop
        }
        if($(noteNode).parent() && ($(noteNode).parent().is('a') || $(noteNode).parent().hasClass('gold_line'))){
            $(noteNode).parent().css('padding-bottom', '2px');
        }

        //整个节点被划线（划线内容与节点的长度相同），直接给这个节点设置属性
        if(type == 'all' || noteNode_textContent.length == noteText.length){
            $(noteNode).attr('data-noteid', note_id).attr('data-notecontent', note_content).attr('data-notetype', +note_type).addClass('note-unit').addClass('base-text').addClass('base-node');
        }else{ //节点的部分内容被划线
            if(type == 'latter'){//起始节点，只给后半段匹配内容设置属性
                // console.log("index::::::",index)
                // 从节点的起始位置开始
                if(index == 1){
                    let newFirstSpan = $('<span class="note-unit base-text base-node"  data-noteid='+note_id+' data-notetype='+ note_type + ' data-notecontent='+ note_content+'>'+noteText+'</span>')
                    let newSecondSpan = $('<span class="base-text base-node">'+noteNode_textContent.substr(noteText.length)+'</span>')
                    $(noteNode).replaceWith(newFirstSpan.add(newSecondSpan));
                //从节点的非起始位置开始，往后全部划线
                }else if(noteNode_textContent.substr(index-1).length == noteText.length){
                    let newFirstSpan = $('<span class="base-text base-node">'+noteNode_textContent.substr(0, index-1)+'</span>')
                    let newSecondSpan = $('<span class="note-unit base-text base-node"  data-noteid='+note_id+' data-notetype='+ note_type + ' data-notecontent='+ note_content+'>'+noteText+'</span>')
                    $(noteNode).replaceWith(newFirstSpan.add(newSecondSpan));
                 //从节点的非起始位置开始，结束点不在节点的结尾
                }else{
                    let newFirstSpan = $('<span class="base-text base-node">'+noteNode_textContent.substr(0, index-1)+'</span>')
                    let newSecondSpan = $('<span class="note-unit base-text base-node"  data-noteid='+note_id+' data-notetype='+ note_type + ' data-notecontent='+ note_content+'>'+noteText+'</span>')
                    let newThirdSpan = $('<span class="base-text base-node">'+noteNode_textContent.substr(index-1+noteText.length)+'</span>')
                    $(noteNode).replaceWith(newFirstSpan.add(newSecondSpan).add(newThirdSpan));
                }

            }else if(type == 'former'){//结束节点，只给前半段匹配内容设置属性
                let newFirstSpan = $('<span class="note-unit base-text base-node"  data-noteid='+note_id+' data-notetype='+ note_type + ' data-notecontent='+ note_content+'>'+noteText+'</span>')
                let newSecondSpan = $('<span class="base-text base-node">'+noteNode_textContent.substr(latter_node_text.length)+'</span>')
                $(noteNode).replaceWith(newFirstSpan.add(newSecondSpan));
            }
            
        }

        
        
    }
    
    // 获取正文html所有基本节点（不包含只有空格、换行的节点）
    function getBasicNodes(node) {
        var basicNodes = [];
        if ((node.nodeType !== Node.ELEMENT_NODE || node.childNodes.length === 0) &&
        !isWhitespaceNode(node)) {
            basicNodes.push(node); // 将非元素节点或没有子节点的元素节点添加到数组
        } else {
            // 遍历元素节点的子节点
            var childNodes = node.childNodes;
            for (var i = 0; i < childNodes.length; i++) {
            basicNodes = basicNodes.concat(getBasicNodes(childNodes[i])); // 递归处理子节点
            }
        }
        return basicNodes;
    }

    // 检查节点是否只包含换行或空格符
    function isWhitespaceNode(node) {
        return (
            node.nodeType === Node.TEXT_NODE &&
            /^\s*$/.test(node.nodeValue) // 使用正则表达式检查文本是否只包含换行或空格符
        );
    }
    // 给所有基本节点设置data-index属性，不能设置属性的文本节点，包裹一层span标签
    function setBaseNodesIndexAttributes(node, index) {
            try {
                node.setAttribute('data-index', index);
                node.classList.add('base-node');
            } catch (error) {
                var textContent = node.textContent || node.innerText; // 兼容性处理
                if(textContent){
                    // 如果设置属性失败，创建 span 元素
                    var spanNode = document.createElement('span');
                    spanNode.setAttribute('data-index', index);
                    spanNode.classList.add('base-node'); // 添加 base-node 类
                    // 所有文本节点，添加base-text类
                    if(node.nodeType == 3){
                        spanNode.classList.add('base-text'); 
                        allNodeText += node.nodeValue;
                        allNodeText_filter += node.nodeValue.replace(/\s/g, '');
                    }
                    // 将原节点的文本内容移到 span 中
                    var textNode = document.createTextNode(textContent);
                    spanNode.appendChild(textNode);
                    // 将 span 替换原节点
                    node.parentNode.replaceChild(spanNode, node);
                }
              
            }
    }
    // 模糊匹配，比较两个字符串中的相同字符
    function compareStrings(str1, str2) {
        let resultStr = "";
        // 遍历第一个字符串的字符
        for (let i = 0; i < str1.length; i++) {
            let currentChar = str1[i];
            // 查找第二个字符串中是否包含当前字符
            let indexInStr2 = str2.indexOf(currentChar);
            // 如果找到了相同的字符
            if (indexInStr2 !== -1) {
                // 将相同的字符添加到结果字符串
                resultStr += currentChar;

                // 从第二个字符串中删除该字符
                str2 = str2.slice(0, indexInStr2) + str2.slice(indexInStr2 + 1);
            }
        }
        // console.log("resultStr:",resultStr)
        // console.log("str1:",str1)
        if(resultStr.length/str1.length >=0.8 || ((str1.length - resultStr.length)<=3 && str1.length>3)){
            return true;
        }else{
            return false;
        }
        
    }
    function getSelectionLimit(){
        let index = ''
        let selection = window.getSelection()
        let limit = true
        if (selection.rangeCount > 0) {
            // 获取选中文本的 Range 对象
            
            let range = selection.getRangeAt(0);
            let baseNodeList = $('.base-node').toArray()

            // 获取选中文字的首字符所在的节点
            let startNode = range.startContainer.nodeType === 3
            ? range.startContainer.parentNode
            : range.startContainer;
         
            let start_index = baseNodeList.indexOf(startNode)
             // 获取选中文字的首字符所在的节点
             let endNode = range.endContainer.nodeType === Node.TEXT_NODE
            ? range.endContainer.parentNode
            : range.endContainer;
         
            let end_index = baseNodeList.indexOf(endNode)

            if (start_index === -1 && startNode.hasChildNodes()) {
            // 遍历所有子节点
                for (let i = 0; i < startNode.childNodes.length; i++) {
                    let childNode = startNode.childNodes[i];
                    // 检查子节点是否包含 class 名为 base-node
                    if (childNode.nodeType === Node.ELEMENT_NODE && childNode.classList.contains('base-node')) {
                        // 找到第一个包含 class 名为 base-node 的子节点
                        start_index = baseNodeList.indexOf(childNode)
                        // console.log('Found child node with class base-node:', childNode);
                        break;
                    }
                }
            }

            if (end_index === -1 && endNode.hasChildNodes()) {
            // 遍历所有子节点
                for (let i = 0; i < endNode.childNodes.length; i++) {
                    let childNode = endNode.childNodes[i];
                    // 检查子节点是否包含 class 名为 base-node
                    if (childNode.nodeType === Node.ELEMENT_NODE && childNode.classList.contains('base-node')) {
                        // 找到第一个包含 class 名为 base-node 的子节点
                        end_index = baseNodeList.indexOf(childNode)
                        // console.log('Found child node with class base-node:', childNode);
                        break;
                    }
                }
            }
            // console.log("startNode:",startNode)
            // console.log("start_index:",start_index)
            // console.log("endNode:",endNode)
            // console.log("end_index:",end_index)

            if(start_index>=0 && end_index>=0 && start_index<=end_index){
                for (var i = start_index; i <= end_index; i++) {
                    var currentElement = baseNodeList[i];
                    // console.log("currentElement:",currentElement)
                    // 检查当前元素是否存在以及其父节点是否为 img
                    var firstChild = currentElement.firstElementChild;
                    var parentElement = currentElement.parentNode;
                    if (currentElement && ((currentElement.tagName.toLowerCase() === 'img' && !currentElement.classList.contains('note')) || parentElement.classList.contains('img-info') || parentElement.classList.contains('timestamp'))) {
                        // 在这里执行你的逻辑
                        limit = false
                        break;
                    }
                    if(firstChild && firstChild.nodeName.toLowerCase() === 'img'){
                        limit = false
                        break;
                    }
                }   
            }else if(start_index == -1 || end_index == -1){
                limit = false
            }        
        }
        return limit
    }
    function getSelectionIndex(){
        let index = ''
        let selection = window.getSelection()
        if (selection.rangeCount > 0) {
            // 获取选中文本的 Range 对象
            let range = selection.getRangeAt(0);

            // 获取选中文字的首字符所在的节点
            let startNode = range.startContainer.nodeType === 3
            ? range.startContainer.parentNode
            : range.startContainer;
            // 获取首字符在这个节点中的位置
            let startOffset = range.startOffset;
            
            let baseTextList = $('.base-text').toArray()

            let node_index = baseTextList.indexOf(startNode)
            // 获取选中节点之前的所有节点的文本字符数
            let totalCharacterCount = 0;
            for (var i = 0; i < node_index; i++) {
                let textContent = baseTextList[i].textContent || baseTextList[i].innerText
                totalCharacterCount += textContent.length;
            }
            if(node_index == -1){
                index = ''
            }else{
                index = parseInt(totalCharacterCount) + parseInt(startOffset)
            }       
            
        }

        return index
    }
    // 判断选中内容是否包含笔记/摘录
    function checkNoteContentSelect(){
        note_is_chosen = "0"
        note_chosen_data = null;
        let selection = window.getSelection()
        selection = selection.toString().replace(/\n/g, '')
        let selection_filter = selection.replace(/\s/g, '');
        let selection_index = 0
        let selection_length = 0
        let base_node_length = 0
        let base_node_list = []
        let base_node_text = ""
        let base_node_start = 0
        let compare_flag = true
        let last_node_content = ''
        // 判断选中的内容是否在base-text拼起来的全部文本之中
        // 如果是点击的摘录，直接使用点击时获取的数据
        
        if(version410){
            isSelecetNoteContent = true
        }else{
            isSelecetNoteContent = false
        }
        // 点击摘录时直接使用点击摘录时获取的数据
        if(note_chosen_data_click){
            note_chosen_data = JSON.parse(JSON.stringify(note_chosen_data_click))
            note_chosen_data.content_id = article_data.content_id
            note_chosen_data.article_id = article_data.article_id
            note_chosen_data.article_title = article_data.article_title
            note_chosen_data.content_title = article_data.content_title
            note_chosen_data.image = article_data.background_img
            note_chosen_data.author = article_data.author
            note_chosen_data_click = null
            return
        }else if(allNodeText_filter.includes(selection_filter)){
            if(!getSelectionLimit()){
                isSelecetNoteContent = false
                return
            }
            // 获取选中文本首字符在文本中的索引位置
            if(allNodeText.indexOf(selection)!=-1){
                selection_index = allNodeText.indexOf(selection)
            }else{
                selection_index = allNodeText_filter.indexOf(selection_filter)
            }
            selection_index =  getSelectionIndex() ? getSelectionIndex() : selection_index
            selection_length = selection.length
            let baseTextList = $('.base-text').toArray()
            // 循环所有base-text节点，找到选中文本所在的一个或多个节点
            for(let i=0;i<baseTextList.length;i++){
                if(compare_flag){
                    let baseText_text = baseTextList[i].textContent || baseTextList[i].innerText
                    base_node_length += baseText_text.length
                    // 寻找选中文本所在的起始节点
                    if(base_node_list.length < 1){
                        if(base_node_length >= selection_index+1){
                            base_node_start = selection_index - (base_node_length - baseText_text.length)
                            base_node_text = baseText_text.substr(base_node_start); 
                            if(base_node_text.length>=selection_length){
                                base_node_list.push(baseTextList[i])
                                compare_flag = false
                                break;
                            }else{
                                base_node_list.push(baseTextList[i])
                            }
                        }
                    // 如果选中文本超过起始节点的范围，继续循环、比对后面的节点
                    }else {
                        let template_node_text = base_node_text + baseText_text;
                        if(template_node_text.length >= selection_length){
                            last_node_content = baseText_text.substr(0,selection_length-base_node_text.length)//划线内容横跨多个节点时，其在最后一个节点里对应的字符串。计算方法：划线内容全长 - 前面累计的节点内容的全长，得到剩余内容的长度，在此节点中从首字符开始，截取这个长度的内容。
                            base_node_list.push(baseTextList[i])
                            compare_flag = false
                            break
                        }else{
                            base_node_text = base_node_text + baseText_text;
                            base_node_list.push(baseTextList[i])
                        }                    
                    }
                }
            }
        }else{
            isSelecetNoteContent = false
        }        
        
        console.log("base_node_list:",base_node_list)
        // console.log("isSelecetNoteContent:",isSelecetNoteContent)
        if(base_node_list.length>1){
            selection = getSelectionContent(base_node_list,selection,last_node_content).selection ? getSelectionContent(base_node_list,selection,last_node_content).selection : selection
            selection_index = getSelectionContent(base_node_list,selection,last_node_content).selection_index!=-1 ? getSelectionContent(base_node_list,selection,last_node_content).selection_index : selection_index
        }
        if(isSelecetNoteContent){
            checkNodeList(base_node_list,selection,selection_index)
        }
    }
    // 修正选中内容的全文，如果起始字符、结束字符所在的节点，是笔记/摘录，那么需要将笔记或摘录的内容拼接到选中内容上
    function getSelectionContent(node_list,selected_content,last_node_content){
        let obj = {
            selection : "",
            selection_index : -1
        }
        let tem_content = ''
        let start_note_list = []
        let last_note_list = []
        let select_node_list = []
        let first_content = node_list[0].textContent || node_list[0].innerText
        let last_content = node_list[node_list.length-1].textContent || node_list[node_list.length-1].innerText
        let select = window.getSelection()
        let range = select.getRangeAt(0);
        
        // 获取首字符在这个节点中的位置
        let startOffset = range.startOffset;
        if(node_list[0].classList.contains('note-unit') || node_list[node_list.length-1].classList.contains('note-unit')){
            if(node_list[0].classList.contains('note-unit') && node_list[node_list.length-1].classList.contains('note-unit') && $(node_list[0]).attr('data-noteid') == $(node_list[node_list.length-1]).attr('data-noteid')){
                return obj
            }
            // 这里需要找到起始节点和结束节点，然后获取整个文本字符
            if(node_list[0].classList.contains('note-unit')){
                let noteId = $(node_list[0]).attr('data-noteid')
                if(getNoteData(noteId).remark_index){
                    obj.selection_index = parseInt(getNoteData(noteId).remark_index)-1
                }
                node_list = node_list.filter(function(element) {
                    return $(element).attr('data-noteid') != noteId;
                });
                start_note_list = document.querySelectorAll('[data-noteid="'+noteId+'"]');
            }
            if(node_list[node_list.length-1].classList.contains('note-unit') && $(node_list[node_list.length-1]).attr('data-noteid')){
                let noteId = $(node_list[node_list.length-1]).attr('data-noteid')
                node_list = node_list.filter(function(element) {
                    return $(element).attr('data-noteid') != noteId;
                });
                last_note_list = document.querySelectorAll('[data-noteid="'+noteId+'"]');
            }
        }
        if(start_note_list.length>0 || last_note_list.length>0){
            let select_content = ''
            let tem_content = ''
            if(start_note_list.length>0){
                select_node_list = [...start_note_list, ...node_list]
                // console.log("start_note_list:::::::",start_note_list)
            }
            if(last_note_list.length>0){
                if(select_node_list.length>0){
                    select_node_list = [...select_node_list, ...last_note_list]
                }else{
                    select_node_list = [...node_list, ...last_note_list]
                }
                
                // console.log("last_note_list:::::::",last_note_list)
            }
            // console.log("select_node_list:::::",select_node_list)
            for(let i=0;i<select_node_list.length;i++){
                if(i == 0){
                    if(start_note_list.length>0){
                        tem_content = select_node_list[i].textContent || select_node_list[i].innerText
                    }else{
                        tem_content = first_content.substr(startOffset)
                    }
                }else if(i == select_node_list.length-1){
                    if(last_note_list.length>0){
                        tem_content += select_node_list[i].textContent || select_node_list[i].innerText
                    }else{
                        tem_content += last_node_content
                    }
                }else{
                    tem_content += select_node_list[i].textContent || select_node_list[i].innerText
                }
            }
            // console.log("tem_content:::::",tem_content)
            obj.selection = tem_content
        }

        return obj
    }

    function checkNodeList(node_list,selection,indx){
        let note_list = []
        let excerpt_list = []
        let new_node_list = [];
        let note_ids = []
        let content = []
        node_list.forEach((node, index) => {
            if(node.classList.contains('note-unit')){
                let noteid = $(node).attr('data-noteid');
                if(noteid){
                    // 检查新数组中是否已经存在相同的 noteid
                    let isNoteIdExist = new_node_list.some(existingNode => $(existingNode).attr('data-noteid') === noteid);
                    if (!isNoteIdExist) {
                        // 如果新数组中不存在相同的 noteid，则将节点添加到数组中
                        new_node_list.push(node);
                    }
                }
            }
        });
        if(new_node_list.length>=1){
            new_node_list.forEach((node, index) => {
                let noteContentData = $(node).attr('data-notecontent');
                note_ids.push($(node).attr('data-noteid'))
                if(noteContentData){
                    content.push(noteContentData)
                    note_list.push(node)
                }else{
                    excerpt_list.push(node)
                }
            })
        }
        console.log("new_node_list:",new_node_list)
        console.log("note_list:",note_list)
        console.log("excerpt_list:",excerpt_list)
        // 弹窗有笔记/摘录功能
        if(isSelecetNoteContent){
            // 空白文档
            if(note_list.length<1 && excerpt_list.length<1){
                note_chosen_data={
                    showType : 1,
                    remark_index:parseInt(indx)+1,
                    remark_text:selection,
                    note_content:"",
                    del_note_ids:"",
                    note_id:"",
                    type: "1"
                }
            // 只有一条摘录
            }else if(note_list.length < 1 && excerpt_list.length == 1){
                if(isNoteIncludeSelection(selection,note_ids[0])){
                    note_chosen_data={
                        showType : 2,
                        remark_index:parseInt(indx)+1,
                        remark_text:selection,
                        note_id : note_ids[0],
                        note_content:"",
                        del_note_ids:"",
                        type: "2"
                    }
                }else{
                    note_chosen_data={
                        showType : 1,
                        remark_index:parseInt(indx)+1,
                        remark_text:selection,
                        note_id : "",
                        note_content:"",
                        del_note_ids:note_ids[0],
                        type: "1"
                    }
                }
            // 只有多条摘录
            }else if(note_list.length < 1 && excerpt_list.length > 1){
                note_chosen_data={
                    showType : 1,
                    remark_index:parseInt(indx)+1,
                    remark_text:selection,
                    del_note_ids : note_ids.join(','),
                    note_content:"",
                    note_id:"",
                    type: "1"
                }
            // 只有一条笔记
            }else if(note_list.length == 1 && excerpt_list.length < 1){
                if(isNoteIncludeSelection(selection,note_ids[0])){
                    note_chosen_data={
                        showType : 3,
                        remark_index:parseInt(indx)+1,
                        remark_text:selection,
                        note_id : note_ids[0],
                        note_content:content[0],
                        del_note_ids:"",
                        type: "2"
                    }
                }else{
                    note_chosen_data={
                        showType : 1,
                        remark_index:parseInt(indx)+1,
                        remark_text:selection,
                        note_id : "",
                        note_content:content[0],
                        del_note_ids:note_ids[0],
                        type: "1"
                    }
                }
        
            // 一条或多条笔记，一条或多条摘录
            }else if(note_list.length >= 1){
                note_chosen_data={
                    showType : 4,
                    remark_index:parseInt(indx)+1,
                    remark_text:selection,
                    note_id:"",
                    del_note_ids:note_ids.join(','),
                    note_content:content.join(' '),
                    type: "1"
                }
            }
            note_chosen_data.content_id = article_data.content_id
            note_chosen_data.article_id = article_data.article_id
            note_chosen_data.article_title = article_data.article_title
            note_chosen_data.content_title = article_data.content_title
            note_chosen_data.image = article_data.background_img
            note_chosen_data.author = article_data.author
        }
        console.log("note_chosen_data:",note_chosen_data)   
    }
    // 判断选中文字是否被包含在一条笔记/摘录中，如果是，则显示「取消摘录」or「编辑笔记」，如果不是，则显示「摘录」、「写笔记」，新增一条摘录或笔记。
    function isNoteIncludeSelection(selection,noteId){
        let result = false
        let note_text = ''
        let targetElements = document.querySelectorAll('[data-noteid="'+noteId+'"]');
        for (var i = 0; i < targetElements.length; i++) {
            let textContent = targetElements[i].textContent || targetElements[i].innerText
            note_text += textContent
        }
        result = note_text.includes(selection)
        // console.log("isNoteIncludeSelection:",result)
        return result;
    }
    // 通过noteId，获取这条笔记/摘录的全部数据
    function getNoteData(id){
        for(let i=0;i<note_data.length;i++){
            if(note_data[i].note_id == id){
                return note_data[i]
                break;
            }
        }
        return ''
    }
     //选中文本后判断显示哪些按钮
     function showBtn(){
        if(isSelecetNoteContent && note_chosen_data){
            // console.log("showBtn:::::::note_chosen_data.showType:",note_chosen_data.showType)
            switch (note_chosen_data.showType.toString()){
                // 「摘录、写笔记、分享、复制」，空白文档，写笔记为新增笔记
                case '1':
                    $('.cancel-excerpt').first().hide();
                    $('.edit-note').first().hide();
                    $('.excerpt').first().show();
                    $('.new-note').first().show();
                    break;
                // 「取消摘录、写笔记、分享、复制」，一条或多条摘录，如果只有一条摘录，写笔记为修改笔记；如果有多条摘录，写笔记为新增笔记。
                case '2':
                    $('.cancel-excerpt').first().show();
                    $('.excerpt').first().hide();
                    $('.new-note').first().show();
                    $('.edit-note').first().hide();
                    break;
                // 「修改笔记、分享、复制」，
                //还需判断选中文字是否与remark_text完全一致，如果不一致，且选中文字不包含在笔记文字之内，则显示「写笔记」，其他情况显示「修改笔记」
                case '3':
                    $('.cancel-excerpt').first().hide();
                    $('.excerpt').first().hide();
                    $('.new-note').first().hide();
                    $('.edit-note').first().show();
                    break;
                // 「摘录、写笔记、分享、复制」，一条笔记、一条或多条摘录，或者多条笔记、任意摘录
                case '4':
                    $('.cancel-excerpt').first().hide();
                    $('.new-note').first().show();
                    $('.excerpt').first().show();
                    $('.edit-note').first().hide();
                    break;
                default:
                    console.log('showBtn Invalid day entered.');
            }

        }else{
            $('.cancel-excerpt').first().hide();
            $('.excerpt').first().hide();
            $('.new-note').first().hide();
            $('.edit-note').first().hide();
        }
    }
    

    // 写笔记成功后端的回调
    window.callbackNoteInfo = function  (val) {
        let data = JSON.parse(val);
        let replace_flag = false
        console.log('callbackNoteInfo', data)
       if(data.del_note_ids){
            delNoteData(data.del_note_ids)
       }
       if(data.note_id){
        for(let i=0;i<note_data.length;i++){
            if(note_data[i].note_id == data.note_id){
            replace_flag = true
               replaceNoteData(data,i)
            }else{
                
            }
        }
        if(!replace_flag){
            addNoteData(data)
        }
       }
    }
    function addNoteData(data){
        let temp_data = {
            "note_id": data.note_id,
            "note_type": data.note_type,
            "note_content": data.note_content,
            "remark_text": data.remark_text,
            "remark_index": data.remark_index,
            "content_id": data.content_id,
            "article_id": data.article_id
        }
        note_data.push(temp_data)
        initVariable(note_data,note_data.length-1)
        getTargetNode('note_data',note_data.length-1)
    }
    function replaceNoteData(data,i){
        note_data[i] = {
            "note_id": data.note_id,
            "note_type": data.note_type,
            "note_content": data.note_content,
            "remark_text": data.remark_text,
            "remark_index": note_data[i].remark_index,//这里的data.remark_index有可能是错的，所以用已经修正过的note_data[i].remark_index
            "content_id": data.content_id,
            "article_id": data.article_id
        }
        initVariable(note_data,i)
        getTargetNode('note_data',i)
    }

    function delNoteData(ids){
        ids = ids.toString()
        let idList = []
        if(ids.indexOf(',')!=-1){
            idList=ids.split(',')
        }else{
            idList[0] = ids
        }
        for(let i=0;i<idList.length;i++){
            idList[i] = idList[i].toString()
            let elementsWithNoteId = document.querySelectorAll('[data-noteid="'+idList[i]+'"]');
            elementsWithNoteId.forEach(element => {
                element.removeAttribute('data-noteid');
                // 检查元素是否包含所需属性和类
                if (element.hasAttribute('data-noteType')) {
                    element.removeAttribute('data-noteType');
                }
                if (element.hasAttribute('data-noteContent')) {
                    element.removeAttribute('data-noteContent');
                }
                // 删除 class 名 note-unit
                if (element.classList.contains('note-unit')) {
                    element.classList.remove('note-unit');
                }
            });
        
        }
        for (let i = note_data.length - 1; i >= 0; i--) {
            if (idList.includes(note_data[i].note_id.toString())) {
                note_data.splice(i, 1);
                // console.log("note_data:",note_data)
            }
        }
    }
    // 新版分享
    function shareNoteContent(noteID,shareStr,shareType){
        
        let noteInfo = {
            user_data:user_data,
            note_id: "", //笔记id，如果是新增笔记，值为空
            note_type: "", //1:新增笔记  2:修改笔记
            note_content: "", //笔记内容，没有时传空
            remark_text: shareStr, //文稿被选中的内容
            remark_index: "", //文稿被选中的索引
            content_id: article_data.content_id.toString(), //节目id
            article_id: article_data.article_id.toString(), //小节id
            article_title: article_data.article_title,
            update_date: getTimeStr(),
            content_title: article_data.content_title,
            author: article_data.author,
            image: article_data.background_img,
            share_url: article_data.share_url
        };
        let d = JSON.stringify(noteInfo)
        if (typeof jsbridge != "undefined") {
            if (typeof jsbridge.shareNoteContent == "function") {
                jsbridge.shareNoteContent(d,shareType);
            }
        }
    }
    // 判断子节点中是否含有笔记/摘录节点
    function hasChildNoteUnit(node){
        let hasNote = false
        if (node.hasChildNodes()) {
            // 获取所有子节点
            var childNodes = node.childNodes;

            // 遍历子节点，检查是否含有类名为 note-unit 的子节点
            for (let j = 0; j < childNodes.length; j++) {
                var childNode = childNodes[j];

                if (childNode.nodeType === 1 && childNode.classList.contains('note-unit')) {
                    hasNote = true
                    break; // 如果找到一个就可以结束循环
                }
            }
        }
        return hasNote
    }

    // 调接口--增加一条摘录/笔记
    function noteAddInterface(){
        if(!note_chosen_data){
            return
        }
        let noteInfo = {
            del_note_ids: note_chosen_data.del_note_ids.toString(), //多个ID 用逗号分隔，包括笔记id、划线id，没有时传空
            note_id: '', //笔记id，如果是新增笔记，值为空
            remark_text: note_chosen_data.remark_text.toString(), //文稿被选中的内容
            remark_index: note_chosen_data.remark_index.toString(), //文稿被选中的索引
            note_content: note_chosen_data.note_content.toString(), //笔记内容，没有时传空
            content_id: note_chosen_data.content_id.toString(), //节目id
            article_id: note_chosen_data.article_id.toString(), //小节id
            is_comment: '0',
            api_token:api_token
        };
        if(note_chosen_data.del_note_ids){
            delNoteData(note_chosen_data.del_note_ids.toString())
        }
        $.ajax({
            url: API_HOST + '/api/v2/note/add',
            type: 'POST',
            data: noteInfo,
            dataType: 'JSON',
            success: function (returnData) {
                if (returnData.status == 'success') {
                    let data = returnData.data
                    addNoteData(data)
                    
                }else{
                    console.log('fail')
                }
            }
        });
    }
    // 调接口--删除一条摘录
    function noteDelInterface(){
        if(!note_chosen_data){
            return
        }
        let ids = note_chosen_data.del_note_ids ? note_chosen_data.del_note_ids : note_chosen_data.note_id
        if(!ids){
            return
        }
        $.ajax({
            url: API_HOST+'/api/v2/note/del',
            type: 'POST',
            data: {del_note_ids:ids,api_token:api_token},
            dataType: 'JSON',
            success: function (returnData) {
                if (returnData.status == 'success') {
                    console.log("returnData:",returnData)
                    delNoteData(ids)
                }else{
                    console.log('fail')
                }
            }
        });
    }
     //获取正文全部文本内容并过滤掉所有空格和换行，暂时没有什么用
    // let nodeText = rootElement.textContent.replace(/\s/g, '')

    // 获取所有文本节点
    // function getTextNodes(node) {
    //     var textNodes = [];
    //     if (node.nodeType === Node.TEXT_NODE) {
    //         textNodes.push(node);
    //     } else {
    //         var childNodes = node.childNodes;
    //         for (var i = 0; i < childNodes.length; i++) {
    //         textNodes = textNodes.concat(getTextNodes(childNodes[i]));
    //         }
    //     }
    //     return textNodes;
    // }
    
    //  4.1.0笔记功能  end

    //页面深浅模式初始化判断
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        console.log('darkmode')
        $('body').addClass("night")
    }
    //页面深浅模式切换：原生调用js方法
    window.changeMode = function  (val) {
        console.log('vvvvv', val);
        let data = JSON.parse(val);
        if (data.darkMode == '1' ) {
            $('body').addClass("night")
        } else if(data.darkMode == '0' ) {
            $('body').removeClass("night")
        }
    }
    // 处理https链接
    let alist = document.getElementsByTagName("a");
    alist = [...alist];
    alist.forEach((item, index) => {
        if (item.href.includes("https:")) {
            let url = `vistopia://opennew?redirect_url=${encodeURIComponent(item.href)}`
            item.href = url;
        }
    });

    // 如果文稿第一行是h3或h4标签的标题，设置其距离顶部的距离
    let courseContentElement = document.querySelector('.course-content');
    if (courseContentElement) {
        // 查找第一个子元素
        let firstChild = courseContentElement.firstElementChild;
        // 检查第一个子元素是否为 <h3> 或 <h4>
        if (firstChild && (firstChild.tagName === 'H3' || firstChild.tagName === 'H4')) {
            // 设置 margin-top 样式为 0
            firstChild.style.marginTop = '-8px';
        }
    }

    // 找到所有具有 class 名为 "img-info" 的元素
    let elementsWithClass = document.querySelectorAll('.img-info');
    if(elementsWithClass){
        elementsWithClass.forEach(function(element) {
            // 检查当前元素是否有子元素是 <img> 标签
            if (element.querySelector('img')) {
                // 设置 margin-top 为 0
                element.style.marginTop = '0';
                element.style.padding = '0';
            }
        });
    }
    
    // 搜索词高亮
    window.setKeyWord = function (val) {
        console.log('setkeyword', val);
        let data = JSON.parse(val);
        if (data.keyword) {
            var parentElement = document.getElementsByClassName('course-content')[0];
            var textNodes = getTextNodes(parentElement);
            textNodes.forEach(function(node) {
            var content = node.nodeValue;
            var pattern = new RegExp(data.keyword, 'g');
            var replacement = '<span class="search_key">'+data.keyword+'</span>'
            var replacedContent = content.replace(pattern, replacement);
            var tempElement = document.createElement("div");
            tempElement.innerHTML = replacedContent;
            while (tempElement.firstChild) {
                node.parentNode.insertBefore(tempElement.firstChild, node);
            }
            node.parentNode.removeChild(node);
            });
            function getTextNodes(node) {
                var textNodes = [];
                if (node.nodeType === Node.TEXT_NODE) {
                    textNodes.push(node);
                } else {
                    var childNodes = node.childNodes;
                    for (var i = 0; i < childNodes.length; i++) {
                    textNodes = textNodes.concat(getTextNodes(childNodes[i]));
                    }
                }
                return textNodes;
            }
        } 
    }
    
    //选中文本后是否展示【复制】【分享】按钮：试读文稿不展示
    function shouldShowMenu() {
        if(is_sample == false){
            return true;
        }else {
            return false;
        }
    }
   

    //已有笔记内容（？）
    var _drawLineRecords = [];
    console.log('已有笔记',_drawLineRecords);
    function getNote(note_id) {
        for (var i in _drawLineRecords) {
            var note = _drawLineRecords[i];
            if (note.id == note_id) {
                return note;
                break;
            }
        }
        return null;
    }

    // 已有注释（？）
    var _drawAnnotationRecords = []
    console.log('已有注释',_drawAnnotationRecords);
    function getAnnotationObject(annotation_index) {
        for (var i in _drawAnnotationRecords) {
            var annotation = _drawAnnotationRecords[i];
            if (annotation.index == annotation_index) {
                return annotation;
                break;
            }
        }
        return null;
    }
    

    function showPopover(top,description) {
        if (!shouldShowMenu()) {
            return;
        }
        //TODO 填入
        $('#popoverMarkId').val(description);
        $('#popoverMarkId').hide();
        var popoverHeight = $('#popoverMarkId').height();
        $('#popoverMarkId').css({'top':top-popoverHeight-40,'left':'16px', 'position':'absolute'});
        $('#popoverMarkId').show();
        _isPopverMenuVisable = true;
    }

    function hiddenPopover() {
        if (_isPopverMenuVisable) {
            $('#popoverMarkId').hide();
            _isPopverMenuVisable = false;
        }
    }

    function toggleMenuVisiable(delete_id) {
        if (!shouldShowMenu()) {
            hideMenu();
            return;
        }

        if (delete_id) {
            var note = getNote(delete_id);
            //有填备注的笔记
            if (note.remark_text) {
                $('div.btn-group > button.check-note').val(delete_id);
                $('div.btn-group > button.check-note').show();
                $('div.btn-group > button.note').hide();
            }else {
                $('div.btn-group > button.note').val(delete_id);
                $('div.btn-group > button.note').show();
                $('div.btn-group > button.check-note').hide();
            }
            $('div.btn-group > button.copy').val(delete_id);
            $('div.btn-group > button.delete').val(delete_id);
            $('div.btn-group > button.share').val(delete_id);
            $('div.btn-group > button.delete').show();
            $('div.btn-group > button.line').hide();
        }else {
            $('div.btn-group > button.check-note').hide();
            $('div.btn-group > button.note').val();
            $('div.btn-group > button.note').show();
            $('div.btn-group > button.delete').hide();
            $('div.btn-group > button.line').show();
        }
    }

    function showMenu(top,left,delete_id)
    {
        if (!shouldShowMenu()) {
            return;
        }
        if(version410){
            checkNoteContentSelect()
        }
        
        //var left = $('.course-content').width()/2 - $('#questionMarkId').width()/2;
        $('#questionMarkId').hide();
        toggleMenuVisiable(delete_id);

        var zoom = 'small';
        if(deviceType == 'android'){
            if (zoom == 'big') {
                zoom = 1.2;
            }else if(zoom == 'small') {
                zoom = 0.8;
            }else {
                zoom = 1;
            }
        }else{
            zoom = 1
        }
        
        //console.log('zoom',zoom);
        // console.log('top',top);
        console.log('left',left);

        $('#questionMarkId').css({'top':Math.max(0,top-95) * zoom,'left':Math.max(5,left -60) * zoom,'min-width':'110px'});
        if(version410){
            showBtn()
        }else{
            $('.cancel-excerpt').first().hide();
            $('.excerpt').first().hide();
            $('.new-note').first().hide();
            $('.edit-note').first().hide();
        }
        
        $('#questionMarkId').show();
        _isNoteMenuVisable = true;
    }
   

    var _zoomTimer;
    var _showMenuTimer;
    function showMenuLater(top,left,delete_id) {

        if (!shouldShowMenu()) {
            hideMenu();
            return;
        }

        if ($('#questionMarkId').is(":visible")) {
            hideMenu();
        }
        if (_showMenuTimer) {
            clearTimeout(_showMenuTimer);
        }
        _showMenuTimer = setTimeout(function() {
            console.log('延时后执行',top,delete_id);
            updateMenu(top,left,delete_id);
        }, 350)
    }

    function updateMenu(top,left,delete_id) {
        if ($('#questionMarkId').is(":visible")) {
            $('#questionMarkId').css({'top':top-50});
            if(version410){
                checkNoteContentSelect()
                showBtn()
            }
            
        }else {
            showMenu(top,left,delete_id);
        }
    }

    function hideMenu() {
        if ($('#questionMarkId').is(":visible")) {
            $('#questionMarkId').hide();
            _isNoteMenuVisable = false;
        }
    }

    function clickAnnotation(note,ref) {
        if ((typeof jsbridge) != 'undefined') {
            if (typeof(jsbridge.clickAnnotation) == "function")
            {
                jsbridge.clickAnnotation(note,ref);
            }
        }
        return note;
    }

    function pageLoadFinish() {
        console.log('pageLoadFinish :',helper.getPageHeight());
        if ((typeof jsbridge) != 'undefined') {
            if (typeof(jsbridge.pageLoadFinish) == "function") {
                jsbridge.pageLoadFinish(helper.getPageHeight());
            }
            if (typeof(jsbridge.pageLayout) == "function") {
                jsbridge.pageLayout(helper.getPageHeight(),helper.getPageWeight());
            }
            
        }
    }

    function clickImage(index,imagesUrl,imageUrl) {

        console.log('clickImage',imagesUrl);
        if ((typeof jsbridge) != 'undefined') {
            if (typeof(jsbridge.clickImage) == "function")
            {
                console.log("clickImage2");
                jsbridge.clickImage(imageUrl);
            }
            if (typeof(jsbridge.clickImages) == "function")
            {
                console.log("clickImages");
                jsbridge.clickImages(index,imagesUrl);
            }
        }
    }

    function clickNote(note_id) {
        if ((typeof jsbridge) != 'undefined') {
            if (typeof(jsbridge.clickNote) == "function")
            {
                jsbridge.clickNote(note_id);
            }
        }
    }

    function getRandomNoteID(min, max) {
        min = min || 1000;
        max = max || 9999;
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min)) + min;
    }

    $.prototype.path = function (limit) {
        var rightArrowParents = [];
        var $this = $(this);
        var $parents = $this.parents();
        var $parent = $this.parent();

        var items = $parents.addBack().not('body, html').toArray();
        items.reverse();

        for (var i = 0; i < items.length; i++) {
            var item = items[i];
            var entry = item.tagName.toLowerCase();
            if (item.className) {
                entry += "." + item.className.replace(/ /g, '.');
            }
            if (limit && entry === limit) break;

            rightArrowParents.push(entry);
        }

        // var curIndex = $parent.children().index(this);
        // var curParentIndex = $parent.parent().children().index(this.parent());
        // if (curIndex >= 0) {
        //     rightArrowParents[0] += ':nth-of-type(' + (1 + curIndex) + ')';
        //     rightArrowParents[1] += ':nth-of-type(' + (1 + curParentIndex) + ')';
        // }
        var $curParent =  $parent;
        for(var i = 0; i < rightArrowParents.length; i++) {
            var $curIndex = null;
            var $this = this;
            if (i === 0) {
                $curIndex = $curParent.children().index($this);
                rightArrowParents[0] += ':nth-of-type(' + (1 + $curIndex) + ')';
            } else {
                $curParent = $curParent.parent();
                $this = $this.parent();
                $curIndex = $curParent.children().index($this);
                rightArrowParents[i] += ':nth-of-type(' + (1 + $curIndex) + ')';
            }
        }
        rightArrowParents.reverse();
        return rightArrowParents.join(' ');
    };
    var helper = {
        toast:function(val){
            console.log('toast:',val)
        },
        redrawNotes: function(notes) {
            helper.cleanAllNotes();
            helper.refreshNotes(notes);
            var error = helper._drawOldNotes(_drawLineRecords);
            if (!error) {
                helper._checkNoteDotDistance();
            }
        },
        refreshNotes: function(notes) {
            console.log('添加笔记到本地',_drawLineRecords);
            _drawLineRecords = notes;
            console.log('after 添加笔记到本地',_drawLineRecords);
        },
        cleanNote: function(note_id) {
            var newNode = null;
            $("u[class='note-" + note_id + "']").each(function (i) {

                $(this).replaceWith($(this).html());

            });

            $("div[class='dots-" + note_id + "']").each(function (i) {
                $(this).remove();
            });
            return newNode;
        },
        getURLParameter: function (sParam) {
            var sPageURL = window.location.search.substring(1);
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++) {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam) {
                    return sParameterName[1];
                }
            }
        },
        mode: function (type) {
            var $course = $('.course');
            var $body = $('body');
            var $blockquote = $(".course blockquote");
            console.log($blockquote);
            console.log(123);
            if (type === 'night' && !$course.hasClass('night')) {
                $course.addClass('night');
                $body.addClass('night');
                $blockquote.addClass('night');
            }
            if (!type && $course.hasClass('night')) {
                $course.removeClass('night');
                $body.removeClass('night');
                $body.removeClass('night');
                $blockquote.removeClass('night');
            }
        },
        zoom: function (number) {
            var _time = 350;
            function _zoomAction() {
                _zoomToggle(1);
                var $course = $('.course');
                $course.css({
                    zoom: number
                });
                setTimeout(function () {
                    _zoomToggle(0);
                }, _time);
            }

            function _zoomToggle(start) {
                console.log('zoomToggle',start);
                if ((typeof jsbridge) != 'undefined') {
                    if (typeof(jsbridge.zoomToggle) == "function")
                    {
                        jsbridge.zoomToggle(start);
                    }
                }
            }

            if (!number) number = 1;
            if (_zoomTimer) {
                clearTimeout(_zoomTimer);
                _zoomTimer = setTimeout(function() {
                    _zoomAction();
                }, _time);
            }else {
                _zoomAction();
            }
        },
        getPageHeight: function() {
            return document.body.scrollHeight;
        },
        getPageWeight: function() {
            return document.body.scrollWidth;
        },
        fontSize: function (number) {
            if (!number) number = 12;
            var $body = $('body');
            $body.css({
                'font-size': number
            })
        },
        createItem: function (childNodes,aNode) {
            // console.log(childNodes,aNode);
            if (aNode && childNodes) {
                var item = {
                    type: aNode.localName + ((aNode.className) ? '.'+aNode.className : ''),
                    index: this.getIndexFromNode(childNodes,aNode)
                };
                return item;
            }
            return null;
        },
        getPathFromNode: function (node,selectionStr=null) {
            var paths = [];
            if (node) {
                var rootNode = $('div.course-content')[0];
                var currentNode = node;
                var nodeTrains = [node];
                while (currentNode.parentNode != rootNode) {
                    currentNode = currentNode.parentNode;
                    nodeTrains.unshift(currentNode);
                }
                for (var i in nodeTrains) {
                    var oneNode = nodeTrains[i];
                    var index = Array.prototype.indexOf.call(oneNode.parentNode.childNodes,oneNode);
                    console.log('ondNode : ',oneNode,oneNode.parentNode.childNodes,oneNode.localName,index);
                    var item = {type: (oneNode.localName ?oneNode.localName: 'text') + ((oneNode.className) ? '.'+oneNode.className : ''), index: index};
                    if (item) {
                        console.log('push ========= :',item,oneNode.className,oneNode.localName,index,oneNode.parentNode.childNodes,oneNode);
                        paths.push(item);
                    }
                    currentNode = oneNode;
                }

                //当最后paths的type不为text时，加入一个{type:'text',index:0}
                if (paths.length > 0) {
                    var item = paths[paths.length-1];
                    if (item.type != 'text') {
                        //当选中文字包含br时
                        if (selectionStr) {
                            if (selectionStr.length > 1) {
                                var firstChar = selectionStr.substr(0,1);
                                if (firstChar == '\n') {
                                    var selectionRange = selection.getRangeAt(0);
                                    var child = selectionRange.endContainer;
                                    var parent = child.parentNode;
                                    var childNodes = parent.childNodes;
                                    var count = childNodes.length;
                                    var child_index = -1;
                                    for (var i = 0; i < count; ++i) {
                                        if (child === childNodes[i]) {
                                            child_index = i;
                                            break;
                                        }
                                    }
                                    var indexOfBrNode = child_index-1;
                                    paths.push({type: 'br', index: indexOfBrNode});
                                    console.log('是换行',node.firstElementChild);
                                }
                                console.log('firstChat:',firstChar);
                            }
                        }else {
                            paths.push({type:'text',index:0});
                        }
                    }
                }

                console.log('items:',paths);
            }
            return paths;
        },
        getNodetoPath: function (node) {
            var paths = [];
            if (node) {
                var rootNode = $('div.course-content')[0];
                var parentNode = node.parentNode;
                var greatParentNode = (parentNode && parentNode!=rootNode) ? parentNode.parentNode : null;
                var greatGreatParentNode = (greatParentNode && greatParentNode!=rootNode) ? greatParentNode.parentNode : null;

                var indexOfNodex = Array.prototype.indexOf.call(parentNode.childNodes, node);

                console.log('indexOfNodex : ',indexOfNodex);
                console.log('before parentNode==rootNodex',node,parentNode.childNodes,greatParentNode,greatGreatParentNode,rootNode);

                if (greatGreatParentNode && greatParentNode && parentNode) {
                    // console.log('before greatGreatParentNode');
                    var item = this.createItem(greatGreatParentNode.childNodes,greatParentNode);
                    if (item) {
                        paths.push(item);
                    }
                    item = this.createItem(greatParentNode.childNodes,parentNode);
                    if (item) {
                        paths.push(item);
                    }
                }
                if (!greatGreatParentNode && parentNode) {
                    // console.log('before outside node');
                    var item = this.createItem(rootNode.childNodes,parentNode);
                    if (item) {
                        paths.push(item);
                    }
                }
            }
            return paths;
        },
        _isOverlap: function(idOne,idTwo){
            var objOne=$("#"+idOne),
                objTwo=$("#"+idTwo),
                offsetOne = objOne.offset(),
                offsetTwo = objTwo.offset(),
                topOne=offsetOne.top,
                topTwo=offsetTwo.top;
            console.log('isOverlap : ',objOne,objTwo,topOne,topTwo);
            return Math.abs(topTwo-topOne) < 5;
        },
        getContentInfo: function() {
            var s = "";
            s += " 网页可见区域宽："+ document.body.clientWidth;
            s += " 网页可见区域高："+ document.body.clientHeight; //body
            s += " 网页可见区域宽："+ document.body.offsetWidth + " (包括边线和滚动条的宽)";
            s += " 网页可见区域高："+ document.body.offsetHeight + " (包括边线的宽)";
            s += " 网页正文全文宽："+ document.body.scrollWidth;
            s += " 网页正文全文高："+ document.body.scrollHeight; //窗口
            s += " 网页被卷去的高(ff)："+ document.body.scrollTop;
            s += " 网页被卷去的高(ie)："+ document.documentElement.scrollTop;
            s += " 网页被卷去的左："+ document.body.scrollLeft;
            s += " 网页正文部分上："+ window.screenTop;
            s += " 网页正文部分左："+ window.screenLeft;
            s += " 屏幕分辨率的高："+ window.screen.height;
            s += " 屏幕分辨率的宽："+ window.screen.width;
            s += " 屏幕可用工作区高度："+ window.screen.availHeight;
            s += " 屏幕可用工作区宽度："+ window.screen.availWidth;
            s += " 你的屏幕设置是 "+ window.screen.colorDepth +" 位彩色";
            s += " 你的屏幕设置 "+ window.screen.deviceXDPI +" 像素/英寸";
            return s;
        },
        _checkNoteDotDistance: function () {
            if (!_drawLineRecords || _drawLineRecords.length == 0) {
                return;
            }

            let notes_id_to_position = _drawLineRecords.filter(function (note) {
                if (note.remark_text.length > 0) {
                    return true;
                }else {
                    return false;
                }
            }).map(function (record) {
                return {id:record.id,top:$("#dots-"+record.id).css('top')};
            });

            let groupByTop = _.groupBy(notes_id_to_position,function (item) {
                return item.top;
            });

            let needRemoveItems = [];

            var zoom = 'small';
            if (zoom == 'big') {
                zoom = 1.2;
            }else if(zoom == 'small') {
                zoom = 0.8;
            }else {
                zoom = 1;
            }
            console.log('zoom : ',zoom);

            for (let i=0; i < Object.keys(groupByTop).length; i++) {
                let key = Object.keys(groupByTop)[i];
                let group = groupByTop[key];

                let _dots = $('<div></div>').html('●<br/>');
                _dots.css('position','absolute');
                _dots.css('right','2px');
                _dots.css('color', 'rgba(240,221,113, 1)');
                console.log('key : ',parseFloat(key));
                // _dots.css('top',key);
                _dots.css('top',parseFloat(key)*zoom + 'px');
                _dots.css('height','10px');
                _dots.css('font-size','12px');
                console.log(group,JSON.stringify(group));

                let notes_id = null;
                for (let j=0; j<group.length; j++) {
                    let note_id = group[j];
                    notes_id += note_id.id;
                    if (j != group.length-1) {
                        notes_id += '-';
                    }
                    $("#dots-"+note_id.id).remove();
                }
                if (notes_id) {
                    _dots.addClass('dots-group-'+ notes_id);
                }
                $('body').append(_dots);

                needRemoveItems.push(group);
            }

            console.log(notes_id_to_position,groupByTop,needRemoveItems,Object.keys(groupByTop));

        },
        getPathToNode: function (paths) {
            var node = null;
            if (paths.length > 0) {
                var content = document.querySelector('.course-content');
                var path = paths[0];
                // console.log('getPathToNode',path,paths,content.childNodes);
                var child = this.getNodeFromIndex(content.childNodes,path.index);
                // console.log('getPathToNode 0 :',child);
                if (paths.length > 1) {
                    var path = paths[1];
                    // console.log('getPathToNode',path,paths);
                    // console.log('getPathToNode 1 :',child);
                    if (child) {
                        var child = this.getNodeFromIndex(child.childNodes,path.index);
                        node = child;
                    }
                }else {
                    node = child;
                }
            }
            return node;
        },

        // 递归的深度优先遍历

        /**
         * @param  item:Node
         * @param  parentNode:Node|null
         * @private
         */
        _getNodeByElementAndParentNode: function (item,parentNode,pivotIndex) {
            pivotIndex = pivotIndex || 0;
            if (item == $('.course-content')[0]) {
                parentNode = null;
            }

            var item_childNodes = item.childNodes;
            for (var i = 0; i < item_childNodes.length; i++) {
                var childNode = item_childNodes[i];
                if (childNode.nodeType == 3) {
                    pivotIndex += childNode.length;
                    console.log('_getNodeByElement text',childNode);
                }else if(childNode.nodeName == 'IMG') {
                    pivotIndex ++;
                    console.log('_getNodeByElement img',childNode);
                }else {
                    console.log('_getNodeByElement child.parentNode',childNode,childNode.parentNode);
                    this._getNodeByElementAndParentNode(childNode,childNode.parentNode,pivotIndex);
                }
            }
            return pivotIndex;
        },
        _getNodeClassList: function (selection) {
            if  (selection.rangeCount == 0) {
                console.log('selection is empty');
                return [];
            }
            var selectionRangle = selection.getRangeAt(0);
            var selectionRangleContents = selectionRangle.cloneContents();
            var nodeElements = selectionRangleContents.querySelectorAll('u');
            var storeNodeIDs = new Set();
            if (selectionRangle.commonAncestorContainer.nodeType == 3 && selectionRangle.commonAncestorContainer.parentNode.nodeName == 'U') {
                nodeElements['parentNode'] = selectionRangle.commonAncestorContainer.parentNode;
            }
            for (var x in nodeElements) {
                var node = nodeElements[x];
                // console.log('in node elements',x,nodeElements,node);
                var className = node.className;
                if (node && className) {
                    if (className.length > 5) {
                        storeNodeIDs.add(className.substring(5));
                    }
                }
            }
            return Array.from(storeNodeIDs);
        },
        getCurrentSelection: function () {
            var selection = getSelection();
            if  (selection.rangeCount > 0) {

                var selectionStr = selection.toString();

                var selectionRange = selection.getRangeAt(0);

                //把划线区域包含的笔记先记录下来；
                var nodeIDsInSelection = this._getNodeClassList(selection);
                if (nodeIDsInSelection.length > 0) {
                    //划线区域有包含其它笔记
                    return { start_paths: [],start: 0,end_paths:[],end:0,str:""};
                }

                //删除所有笔记
                this.cleanAllNotes();

                var result = {
                    start_paths: helper.getPathFromNode(selectionRange.startContainer,selectionStr),
                    start: selectionRange.startContainer ? selectionRange.startOffset : 0,
                    end_paths: helper.getPathFromNode(selectionRange.endContainer),
                    end: selectionRange.endContainer ? selectionRange.endOffset : 0,
                    str: selectionStr,
                };

                //重新把旧笔记划上
                var error = this._drawOldNotes(_drawLineRecords);
                if (!error) {
                    this._checkNoteDotDistance();
                }

                return result;
            }else {
                return { start_paths: [],start: 0,end_paths:[],end:0,str:""};
            }
        },
        getIndexFromNode: function (rootContentChildNodes,node) {
            var childNodes = null;
            var index = -1;
            if (rootContentChildNodes) {
                childNodes = Object.keys(rootContentChildNodes).map(function (key) { return rootContentChildNodes[key]; });
            }
            if (childNodes instanceof Array) {
                index = childNodes.indexOf(node);
                console.log(index);
            }
            return index;
        },
        getNodeFromIndex: function (rootContentChildNodes,index) {
            var childNodes = null;
            var node = null;
            if (rootContentChildNodes) {
                childNodes = Object.keys(rootContentChildNodes).map(function (key) { return rootContentChildNodes[key]; });
            }
            if (childNodes instanceof Array && childNodes.length > index) {
                node = childNodes[index];
            }
            return node;
        },
        getNodeIDsInselectionPrefixInParentNode: function (selectionRange) {
            var nodeIDsInSelectionPrefixInParentNode = null;
            if (selectionRange.commonAncestorContainer.nodeType == 3) {
                var childrenOfSelectionParentNode = selectionRange.commonAncestorContainer.parentNode.children;
                var storeNodeIDs = new Set();
                //选取前有笔记
                if (selectionRange.startContainer.previousSibling && selectionRange.endContainer.previousSibling) {
                    if (selectionRange.startContainer.previousSibling.nodeName == 'U' && selectionRange.endContainer.previousSibling.nodeName == 'U') {
                        for (var x = 0; x < childrenOfSelectionParentNode.length; x++) {
                            var childNode = childrenOfSelectionParentNode[x];
                            var className = childNode.className;
                            if (childNode && className) {
                                if (className.length > 5) {
                                    storeNodeIDs.add(className.substring(5));
                                }
                            }
                        }
                    }
                }
                nodeIDsInSelectionPrefixInParentNode = Array.from(storeNodeIDs);
            }
            console.log(nodeIDsInSelectionPrefixInParentNode);
            return nodeIDsInSelectionPrefixInParentNode;
        },
        getOldNotesCrossPathsFromSelectionParentNode: function (selection,nodeIDsInSelectionParentNode){


            var afterRemoveSelection = null;
            if (nodeIDsInSelectionParentNode && nodeIDsInSelectionParentNode.length > 0) {
                //先保存selection里蕴含的关键信息
                var selectionRangle = selection.getRangeAt(0);
                var selectionStr = selection.toString();
                var selectionStartContenter = selectionRangle.startContainer;
                var selectionStartOffset = selectionRangle.startOffset;
                var parentNodeChildNodes = selectionRangle.commonAncestorContainer.parentNode.childNodes;

                //找到划线前一个
                var findLastNode = null;
                for(var _node of parentNodeChildNodes.values()) {
                    if (_node == selectionStartContenter) {
                        console.log('找到',_node);
                        findLastNode = _node;
                        break;
                    }
                    if (_node) {
                        if (_node.nodeType == 3) {
                            selectionStartOffset += _node.length;
                        }else {
                            selectionStartOffset += this.getAllTextNodeLength(_node);
                        }
                    }
                }

                for (var x=0; x < nodeIDsInSelectionParentNode.length; x++) {
                    var oldNodeID = nodeIDsInSelectionParentNode[x];
                    if (oldNodeID) {
                        selectionStartContenter = helper.cleanNote(oldNodeID);
                    }
                }
                console.log('getOldNotesCrossPathsFromSelectionParentNode',selectionStartContenter,selectionStartOffset);
                var range = document.createRange();
                range.setStart(selectionStartContenter.firstChild ? selectionStartContenter.firstChild : selectionStartContenter,selectionStartOffset);
                range.setEnd(selectionStartContenter.firstChild ? selectionStartContenter.firstChild : selectionStartContenter,selectionStartOffset+selectionStr.length);
                selection.removeAllRanges();
                selection.addRange(range);
                afterRemoveSelection = selection;
            }
            return afterRemoveSelection;
        },
        getOldNotesCrossPathsFromSelection: function (selection,nodeIDsInSelection) {
            var unionSectionCrossInfo = null;
            if (nodeIDsInSelection.length > 0) {
                if (nodeIDsInSelection.length == 1) {

                    var selectionRangle = selection.getRangeAt(0);
                    var selectionStr = selection.toString();
                    var oldNodeID = nodeIDsInSelection[0];
                    var oldNode = getNote(oldNodeID);
                    var selectionContainerParentNodeChildNodes = null;

                    console.log('getOldNoteCross ',selectionRangle.endContainer.parentNode.nodeName,selectionRangle.startContainer.parentNode.nodeName);

                    if (selectionRangle.endContainer.parentNode.nodeName == 'U' && selectionRangle.startContainer.parentNode.nodeName != 'U') {
                        //从text交叉进入u-node
                        selectionContainerParentNodeChildNodes = selectionRangle.endContainer.parentNode.parentNode.childNodes;
                        var selectionRangleUNode = selectionRangle.endContainer.parentNode;
                        var crossLength = selectionRangle.endContainer.parentNode.firstChild.length - selectionRangle.endOffset + 1;
                        var selectionContainerParentNode = selectionRangle.endContainer.parentNode.parentNode;
                        var endOffset = 0;

                        var reachStartOff = false;
                        var selectionRangeStartOffset = 0;
                        var indexOfUNode = -1;
                        var unodeOffset = 0;
                        for(var k=0; k < selectionContainerParentNodeChildNodes.length; k++) {
                            var _childNode = selectionContainerParentNodeChildNodes[k];
                            if (!reachStartOff && (_childNode == selectionRangleUNode || _childNode.firstChild == selectionRangleUNode)) {
                                indexOfUNode = k;
                                reachStartOff = true;
                                endOffset += selectionRangleUNode.textContent.length;
                            }else if(!reachStartOff) {
                                var allTextNodeLengthInNode = this.getAllTextNodeLength(_childNode);
                                selectionRangeStartOffset += allTextNodeLengthInNode;
                                endOffset += allTextNodeLengthInNode;
                                unodeOffset += allTextNodeLengthInNode;
                            }
                        }

                        var paths = this.getPathFromNode(selectionContainerParentNode);

                        var unionStr = selectionStr.substring(0,unodeOffset) + selectionRangleUNode.textContent;
                        unionSectionCrossInfo = {
                            cross_at: 'end',
                            union_str: unionStr,
                            union_json: {start_paths:this.getPathFromNode(selectionRangle.startContainer),start:selectionRangle.startOffset,end_paths:paths,end:endOffset}
                        };

                        // var crossStr = selectionContainerParentNode.textContent.substring(selectionRangeStartOffset,selectionRangeStartOffset+crossLength);
                        var startOffset = selectionRangle.startOffset;

                        console.log('find_union_str',unionStr,startOffset,endOffset,selectionRangleUNode.textContent);
                        // var cross_area_json = {start_paths:paths,start:selectionRangeStartOffset,end_paths:paths,end:selectionRangeStartOffset+crossLength};
                        console.log('从text交叉进入u-node',oldNode,unionSectionCrossInfo);

                    }else if(selectionRangle.startContainer.parentNode.nodeName == 'U' && selectionRangle.endContainer.parentNode.nodeName != 'U') {

                        //从u-note交叉进入text
                        selectionContainerParentNodeChildNodes = selectionRangle.startContainer.parentNode.parentNode.childNodes;
                        var selectionRangleUNode = selectionRangle.startContainer.parentNode;
                        var selectionContainerParentNode = selectionRangle.startContainer.parentNode;
                        var startOffset = 0;

                        var reachStartOff = false;
                        var selectionRangeStartOffset = selectionRangle.startOffset;
                        var indexOfUNode = -1;
                        for(var k=0; k < selectionContainerParentNodeChildNodes.length; k++) {
                            var _childNode = selectionContainerParentNodeChildNodes[k];
                            // console.log('before _childNode',_childNode,startOffset);
                            if (!reachStartOff && (_childNode == selectionRangleUNode || _childNode.firstChild == selectionRangleUNode)) {
                                indexOfUNode = k;
                                reachStartOff = true;
                                // console.log('reach _childNode',startOffset,selectionRangleUNode.textContent.length);
                            }else if(!reachStartOff) {
                                var allTextNodeLengthInNode = this.getAllTextNodeLength(_childNode);
                                selectionRangeStartOffset += allTextNodeLengthInNode;
                                startOffset += allTextNodeLengthInNode;
                                // console.log('not reach _childNode',startOffset,allTextNodeLengthInNode);
                            }
                        }

                        var paths = this.getPathFromNode(selectionContainerParentNode);
                        var needDelete = -1;
                        for (var x=0; x < paths.length; x++) {
                            var obj = paths[x];
                            var type = obj ? obj['type'] : undefined;
                            if (type && type.search('u.note') != -1){
                                needDelete = x;
                                break;
                            }
                        }
                        if (needDelete > -1) {
                            console.log('needDelete',needDelete);
                            paths.splice(needDelete,1);
                        }

                        var unionStr = selectionRangleUNode.textContent.substring(0,selectionRangle.startOffset) + selectionStr;
                        unionSectionCrossInfo = {
                            cross_at: 'start',
                            union_str: unionStr,
                            union_json: {start_paths:paths,start:startOffset,end_paths:this.getPathFromNode(selectionRangle.endContainer),end:selectionRangle.endOffset}
                        };

                        console.log('从u-node交叉进入text',unionSectionCrossInfo);
                    }else {
                        console.log('其他情况',selectionRangle)
                    }

                }else {
                    //TODO 删除旧笔记列表，新建笔记信息
                    //多条笔记， 删除旧笔记列表，新建笔记信息
                    unionSectionCrossInfo = {
                        cross_at: 'notes',
                    };
                }
            }
            return unionSectionCrossInfo;
        },
        getAllTextNodeLength: function (node) {
            var allTextNodeLengthInNode = 0;
            if (!node) {
                return allTextNodeLengthInNode;
            }
            if (node.nodeType == 3) {
                allTextNodeLengthInNode += node.length;
                // console.log('node text',node);
            }else {
                for (var k = 0; k < node.childNodes.length; k++) {
                    var subNode = node.childNodes[k];
                    if (subNode.nodeType == 3) {
                        allTextNodeLengthInNode += subNode.length;
                        // console.log('text subNode',subNode.length,allTextNodeLengthInNode,node.childNodes);
                    }else {
                        allTextNodeLengthInNode += subNode.textContent.length;
                        // console.log('not text subNode',subNode,subNode.textContent.length,subNode.textContent,allTextNodeLengthInNode,node.childNodes);
                    }
                }
            }
            return allTextNodeLengthInNode;
        },
        _getNodeChildIndex: function (childNode) {
            var parent = childNode.parentNode;
            var children = parent.childNodes;
            var i = children.length - 1;
            for (; i >= 0; i--){
                if (childNode == children[i]){
                    break;
                }
            }
            return i;
        },
        __cleanOldNotes: function (notes_id,selection,unionInfo) {

            if (!unionInfo) {
                return selection;
            }

            var selectionRange = selection.getRangeAt(0);
            var selectionLength = selection.toString().length;

            var selectionRangleContents = selectionRange.cloneContents();
            var nodeElements = selectionRangleContents.querySelectorAll('u');

            var selectionRangeStartOffset = selectionRange.startOffset;
            var selectionRangeEndOffset = selectionRange.endOffset;

            var selectionRangeStartContainer = selectionRange.startContainer;
            var selectionRangeEndContainer = selectionRange.endContainer;

            var selectionStartNode = selectionRangeStartContainer;
            var selectionEndNode = selectionRangeEndContainer;

            var crossNoteID = null;
            var crossParentNodeText = null;
            var crossParentNode = null;
            var crossNode = null;
            var crossAt = unionInfo.cross_at; /* start end*/
            var crossNoteOffset = null;
            var crossIndexInParentChildNodes = -1;
            if (crossAt == 'start') {
                crossNode = selectionRangeStartContainer.parentNode;
                selectionStartNode = crossNode.parentNode;
            }else if(crossAt == 'end') {
                crossNode = selectionRangeEndContainer.parentNode;
                selectionEndNode = crossNode.parentNode;
            }else if(crossAt == 'notes') {
                //统计最后一个note前面的textNodelength
                var lastUnode = nodeElements.length > 0 ? nodeElements[nodeElements.length-1] : null;
                var commonAncestorContainerChildNodes = selectionRange.commonAncestorContainer.childNodes;
                var lastUnodeIndex = this._getNodeChildIndex(lastUnode);
                if (lastUnodeIndex > -1) {
                    lastUnode = commonAncestorContainerChildNodes[lastUnodeIndex];
                }

                var noteOffset = 0;
                for (var k=0; k<lastUnodeIndex;k++) {
                    var _childNode = commonAncestorContainerChildNodes[k];
                    console.log('_childNode',_childNode);
                    noteOffset += this.getAllTextNodeLength(_childNode);
                }


                //如果最后一个笔记位置在划线区域最尾段落，则需要调整endOffset
                if (lastUnode.parentNode == selectionRange.endContainer.parentNode) {
                    selectionRangeEndOffset = selectionRange.endOffset + noteOffset + lastUnode.textContent.length;
                }


                while (selectionStartNode.nodeType == 3) {
                    if (selectionStartNode.parentNode.nodeName == 'U') {
                        selectionStartNode = selectionStartNode.parentNode.parentNode;
                    }else {
                        selectionStartNode = selectionStartNode.parentNode;
                    }
                }

                while (selectionEndNode.nodeType == 3) {
                    if (selectionEndNode.parentNode.nodeName == 'U') {
                        selectionEndNode = selectionEndNode.parentNode.parentNode;
                    }else {
                        selectionEndNode = selectionEndNode.parentNode;
                    }
                }

                console.log('commonAncestorContainer',commonAncestorContainerChildNodes,lastUnode,lastUnodeIndex,noteOffset,selectionRangeEndOffset);

            }
            if (crossNode) {
                crossNoteID = crossNode.className.substring(5);
                crossParentNode = crossNode.parentNode;

                crossNoteOffset = 0;
                for (var k=0; k<crossParentNode.childNodes.length;k++) {
                    var _childNode = crossParentNode.childNodes[k];
                    console.log('_childNode',_childNode,crossNode);
                    if (_childNode == crossNode) {
                        crossIndexInParentChildNodes = k;
                        break;
                    }else {
                        crossNoteOffset += this.getAllTextNodeLength(_childNode);
                    }
                }

                if (crossAt == 'start') {
                    selectionRangeStartOffset += crossNoteOffset;
                }else if(crossAt == 'end') {
                    selectionRangeEndOffset += crossNoteOffset;
                }

                crossParentNodeText = crossParentNode.textContent;
            }

            // var newNode = helper.cleanNote(crossNoteID);

            // console.log(crossParentNode,crossNoteOffset,(newNode.parentNode == crossParentNode));

            // helper._drawOldNoteWithIDs([crossNoteID]);

            var storeNodeIDs = new Set();
            if (selectionRange.commonAncestorContainer.nodeType == 3 && selectionRange.commonAncestorContainer.parentNode.nodeName == 'U') {
                nodeElements['parentNode'] = selectionRange.commonAncestorContainer.parentNode;
            }
            for (var x in nodeElements) {
                var node = nodeElements[x];
                var className = node.className;
                if (node && className) {
                    if (className.length > 5) {
                        storeNodeIDs.add(className.substring(5));
                    }
                }
            }
            var selectionNodesID = Array.from(storeNodeIDs);
            for (var i=0; i < selectionNodesID.length; i++) {
                var nodeID = selectionNodesID[i];
                helper.cleanNote(nodeID);
            }

            console.log(crossParentNode,crossNoteOffset,selectionStartNode,selectionEndNode,selectionRangeStartOffset);

            if (selectionStartNode && selectionEndNode) {
                var range = document.createRange();
                console.log('_ selection Node',selectionEndNode,selectionEndNode.length,selectionRangeEndOffset);
                range.setStart(selectionStartNode.firstChild ? selectionStartNode.firstChild : selectionStartNode, selectionRangeStartOffset);
                range.setEnd(selectionEndNode.firstChild ? selectionEndNode.firstChild : selectionEndNode, selectionRangeEndOffset);
                selection.removeAllRanges();
                selection.addRange(range);
                console.log('selectionStartNode',range,selectionStartNode.toString().length,selectionEndNode.toString().length,selectionRangeStartOffset,selectionRangeEndOffset);
            }

            return selection;
        },
        _cleanOldNotes: function (notes_id,selection,unionInfo) {
            var results = new Set();

            var selectionRange = selection.getRangeAt(0);
            var selectionLength = selection.toString().length;
            var selectionRangeStartOffset = selectionRange.startOffset;
            var selectionRangeStartContainer = selectionRange.startContainer;
            var selectionRangeEndContainer = selectionRange.endContainer;
            var selectionRangeEndOffset = selectionRange.endOffset;
            var selectionStartNode = null;
            var selectionEndNode = null;
            var reachStartOffset = false;
            var reachEndOffset = false;
            var crossUNode = (unionInfo != null); /*与旧划线交叉，包括内嵌、前交叉、后交叉*/

            if (selectionRangeStartContainer.nodeType == 3) {
                var hasNote = selectionRangeStartContainer.parentNode.nodeName == 'U';
                var selectionChildNodes = null;
                if (hasNote) {
                    crossUNode = true;
                    selectionChildNodes = selectionRangeStartContainer.parentNode.parentNode.childNodes;
                    selectionStartNode = selectionRangeStartContainer.parentNode.parentNode;
                }else {
                    selectionChildNodes = selectionRangeStartContainer.parentNode.childNodes;
                    selectionStartNode = selectionRangeStartContainer.parentNode;
                }


                if (selectionRangeStartContainer.parentNode.nodeName == 'DIV') {
                    for (var i = 0; i < selectionRangeStartContainer.parentNode.children.length; i++) {
                        var child = selectionRangeStartContainer.parentNode.children[i];
                        if (child.tagName == 'U') {
                            hasNote = true;
                            break;
                        }
                    }
                }

                if (hasNote) {
                    selectionRangeStartOffset = 0;
                    for(var j = 0; j < selectionChildNodes.length; j++) {
                        var node = selectionChildNodes[j];
                        if (!reachStartOffset && (node == selectionRangeStartContainer || node.firstChild == selectionRangeStartContainer)) {
                            reachStartOffset = true;
                            selectionRangeStartOffset += selectionRange.startOffset;
                        }else if(!reachStartOffset){
                            var allTextNodeLengthInNode = this.getAllTextNodeLength(node);
                            selectionRangeStartOffset += allTextNodeLengthInNode;
                        }
                        console.log('start node',node,selectionRangeStartContainer,(node == selectionRangeStartContainer || node.firstChild == selectionRangeStartContainer),j,selectionRangeStartOffset);
                    }
                }
                else if(selectionRangeStartContainer == selectionRangeEndContainer && selectionRangeStartContainer.parentNode.nodeName == 'U') {
                    //划线区域在旧笔记内
                    crossUNode = true;
                    selectionRangeStartOffset = selectionRangeStartContainer.parentNode.previousSibling.length + selectionRange.startOffset;
                    selectionRangeEndOffset = selectionRangeStartOffset + selectionLength;
                    console.log('selectionRangeStartOffset ',selectionRangeStartOffset,selectionRangeEndOffset);
                }
            }

            if (selectionRangeEndContainer.nodeType == 3) {

                var hasNote = selectionRangeEndContainer.parentNode.nodeName == 'U';
                var selectionChildNodes = null;
                if (hasNote) {
                    crossUNode = true;
                    selectionChildNodes = selectionRangeEndContainer.parentNode.parentNode.childNodes;
                    selectionEndNode = selectionRangeEndContainer.parentNode.parentNode;
                }else {
                    selectionChildNodes = selectionRangeEndContainer.parentNode.childNodes;
                    selectionEndNode = selectionRangeEndContainer.parentNode;
                }

                if (selectionRangeEndContainer.parentNode.nodeName == 'DIV') {
                    for (var i = 0; i < selectionRangeEndContainer.parentNode.children.length; i++) {
                        var child = selectionRangeEndContainer.parentNode.children[i];
                        // console.log(child.tagName);
                        if (child.tagName == 'U') {
                            hasNote = true;
                            break;
                        }
                    }
                }

                if (hasNote) {
                    selectionRangeEndOffset = 0;
                    for(var j = 0; j < selectionChildNodes.length; j++) {
                        var node = selectionChildNodes[j];
                        // console.log('end node',node,selectionRangeEndContainer,(node == selectionRangeEndContainer),j,selectionRangeEndOffset,selectionRangeEndContainer.parentNode.childNodes);
                        if (!reachEndOffset && (node == selectionRangeEndContainer || node.firstChild == selectionRangeEndContainer)) {
                            reachEndOffset = true;
                            selectionRangeEndOffset += selectionRange.endOffset;
                        }else if(!reachEndOffset){
                            var allTextNodeLengthInNode = this.getAllTextNodeLength(node);
                            selectionRangeEndOffset += allTextNodeLengthInNode;
                        }
                        // console.log('end node',node,selectionRangeEndContainer,j,(node == selectionRangeEndContainer || node.firstChild == selectionRangeEndContainer),selectionRangeEndOffset,selectionChildNodes);
                    }
                }
            }

            for (var i = 0; i < notes_id.length; i++) {
                var u_class_name = 'u.note-' + notes_id[i];
                if ($(u_class_name).length > 0) {
                    for (var j = 0; j < $(u_class_name).length; j++) {
                        var u_element = $(u_class_name)[j];
                        results.add(u_element);
                        console.log('u_element',j,u_element,u_element.parentNode,selectionRangeStartContainer,selectionRangeEndContainer);
                    }
                }
            }

            console.log('before results',results);

            results = Array.from(results);

            console.log('after results',results);

            for (var k = 0; k < results.length; k++) {
                var u_element = results[k];
                var u_element_parent = u_element.parentNode;
                var u_element_previousSibling = u_element.previousSibling;
                var u_element_childNodes = u_element.parentNode.childNodes;
                var new_text_content = null;
                var u_element_nextText = null;
                for (var x = 0; x < u_element_childNodes.length; x++) {
                    var u_element_parent_child = u_element_childNodes[x];
                    if (u_element_parent_child == u_element && x < u_element_childNodes.length) {
                        u_element_nextText = u_element_childNodes[x+1];
                        break;
                    }
                }
                if (u_element_previousSibling.nodeType == 3) {
                    new_text_content = document.createTextNode(u_element_previousSibling.textContent + u_element.textContent + (u_element_nextText?u_element_nextText.textContent:''));
                    if (crossUNode || unionInfo) {
                        selectionStartNode = new_text_content;
                    }
                }else {
                    new_text_content = document.createTextNode(u_element.textContent);
                }
                console.log('u_element_parent',u_element_parent,u_element,new_text_content,u_element_previousSibling);
                if (u_element_previousSibling) {
                    u_element_previousSibling.remove();
                }
                u_element_parent.replaceChild(new_text_content,u_element);
                if (u_element_nextText) {
                    u_element_nextText.remove();
                }
            }


            if (selectionStartNode || selectionEndNode) {
                var range = document.createRange();
                console.log('_ selection Node',selectionEndNode,selectionEndNode.length,selectionRangeEndOffset);
                range.setStart(selectionStartNode.firstChild ? selectionStartNode.firstChild : selectionStartNode, selectionRangeStartOffset);
                range.setEnd(selectionEndNode.firstChild ? selectionEndNode.firstChild : selectionEndNode, selectionRangeEndOffset);
                selection.removeAllRanges();
                selection.addRange(range);
                console.log('selectionStartNode',range,selectionStartNode.toString().length,selectionEndNode.toString().length,selectionRangeStartOffset,selectionRangeEndOffset);
            }

            return selection;
        },
        _drawOldNoteWithIDs: function (notes_id) {
            var notes = [];
            for (var i=0;i<notes_id.length;i++) {
                var note = getNote(notes_id[i]);
                if (note) {
                    notes.push(note);
                }
            }
            if (notes.length > 0) {
                this._drawOldNotes(notes);
            }
        },
        getPageSize:function(){
            var xScroll, yScroll;
            if (window.innerHeight && window.scrollMaxY) {
                xScroll = document.body.scrollWidth;
                yScroll = window.innerHeight + window.scrollMaxY;
            } else if (document.body.scrollHeight > document.body.offsetHeight){
// all but Explorer Mac
                xScroll = document.body.scrollWidth;
                yScroll = document.body.scrollHeight;
            } else {
// Explorer Mac...would also work in Explorer 6 Strict, Mozilla and Safari
                xScroll = document.body.offsetWidth;
                yScroll = document.body.offsetHeight;
            }
            var windowWidth, windowHeight;
            if (self.innerHeight) { // all except Explorer
                windowWidth = self.innerWidth;
                windowHeight = self.innerHeight;
            } else if (document.documentElement && document.documentElement.clientHeight) {
// Explorer 6 Strict Mode
                windowWidth = document.documentElement.clientWidth;
                windowHeight = document.documentElement.clientHeight;
            } else if (document.body) { // other Explorers
                windowWidth = document.body.clientWidth;
                windowHeight = document.body.clientHeight;
            }
// for small pages with total height less then height of the viewport
            if(yScroll < windowHeight){
                pageHeight = windowHeight;
            } else {
                pageHeight = yScroll;
            }
            if(xScroll < windowWidth){
                pageWidth = windowWidth;
            } else {
                pageWidth = xScroll;
            }
            arrayPageSize = new Array(pageWidth,pageHeight,windowWidth,windowHeight)
            return arrayPageSize;
//return pageHeight;
        },
        _drawOldNotes: function (notes) {

            var groupsBylength = new Object();
            for (var k=0; k<notes.length;k++) {
                var note = notes[k];
                var noteObj = JSON.parse(JSON.stringify(note));
                var sentence_json = JSON.parse(noteObj.remark_sentence_json);
                var length = 0;
                if (sentence_json) {
                    length = sentence_json.start_paths.length;
                }
                var group = groupsBylength[length];
                if (!group) {
                    groupsBylength[length] = [note];
                }else {
                    group.push(note);
                }
            }

            console.log('groupByLength',groupsBylength);

            function sortCopy(arr,sortFn) {
                return arr.slice(0).sort(sortFn);
            }

            function sortByIndex(i) {
                return function (note_a,note_b) {
                    var noteObjA = JSON.parse(JSON.stringify(note_a));
                    var noteObjB = JSON.parse(JSON.stringify(note_b));
                    var sentence_json_a = JSON.parse(noteObjA.remark_sentence_json);
                    var sentence_json_b = JSON.parse(noteObjB.remark_sentence_json);

                    if (sentence_json_a && sentence_json_b &&
                        sentence_json_a.start_paths.length == sentence_json_b.start_paths.length &&
                        sentence_json_a.start_paths.length > 0) {
                        var start_path_a_i = sentence_json_a.start_paths[i];
                        var start_path_b_i = sentence_json_b.start_paths[i];
                        // if (start_path_a_i == start_path_b_i) {
                        //     console.log('sortByIndex',start_path_a_i.index,start_path_b_i.index,i);
                        //     return (sentence_json_b.start - sentence_json_a.start) > 0 ? 1 : -1;
                        // }else {
                        return start_path_b_i.index - start_path_a_i.index;
                        // }
                    }else {
                        console.log('sortByIndex  :',sentence_json_b,sentence_json_a);
                        return 0;
                    }
                }
            }

            function groupBy( array , f ) {
                var groups = {};
                array.forEach( function( o )
                {
                    var group = JSON.stringify( f(o) );
                    groups[group] = groups[group] || [];
                    groups[group].push( o );
                });
                return Object.keys(groups).map( function( group )
                {
                    return groups[group];
                });
            }

            function sortByStartOffset(note_a,note_b) {
                var noteObjA = JSON.parse(JSON.stringify(note_a));
                var noteObjB = JSON.parse(JSON.stringify(note_b));
                var sentence_json_a = JSON.parse(noteObjA.remark_sentence_json);
                var sentence_json_b = JSON.parse(noteObjB.remark_sentence_json);
                var start_a = sentence_json_a.start;
                var start_b = sentence_json_b.start;
                var start_paths_a = sentence_json_a.start_paths;
                var start_paths_b = sentence_json_b.start_paths;

                var is_start_paths_same = false;
                var start_path_a_i = null;
                var start_path_b_i = null;
                for (var i = 0; i < start_paths_a.length; i++) {
                    start_path_a_i = start_paths_a[i];
                    start_path_b_i = start_paths_b[i];
                    if (start_path_a_i.type != start_path_b_i.type || start_path_a_i.index != start_path_b_i.index) {
                        is_start_paths_same = false;
                        break;
                    }else {
                        is_start_paths_same = true;
                    }
                }

                // console.log('sortByStartOffset : ',is_start_paths_same,start_path_a_i,start_path_b_i);

                if (start_a && start_b && is_start_paths_same) {
                    // console.log('sortByStartOffset',start_b - start_a);
                    return (start_b - start_a) > 0 ? 1 : -1;
                }else {
                    return 0;
                }
            }

            for (var length in groupsBylength) {
                var groups = groupsBylength[length];

                var length_i = 1;
                var drawSortNotes = groups;
                while (length_i < length) {
                    drawSortNotes = sortCopy(drawSortNotes,sortByIndex(length_i));

                    console.log('_sort 第',length_i+1,drawSortNotes,drawSortNotes.map(function (item) {
                        return JSON.parse(JSON.parse(JSON.stringify(item.remark_sentence_json))).start_paths[1];
                    }),drawSortNotes.map(function (item) {
                        return JSON.parse(JSON.parse(JSON.stringify(item.remark_sentence_json))).start;
                    }));
                    length_i++;
                }

                //找出相同sortByIndex的内部排序
                var grouped = groupBy(drawSortNotes, item => JSON.stringify(JSON.parse(JSON.parse(JSON.stringify(item.remark_sentence_json))).start_paths));
                var tempDrawSortNotes = [];
                for (var e in grouped) {
                    var array = grouped[e];
                    if (array.length > 1) {
                        array = sortCopy(array,sortByStartOffset);
                    }
                    for (var i in array) {
                        tempDrawSortNotes.push(array[i]);
                    }
                }
                drawSortNotes = tempDrawSortNotes;

                console.log('finish drawSortNotes',drawSortNotes);

                for (var note_i=0; note_i<drawSortNotes.length; note_i++) {
                    var drawNote = drawSortNotes[note_i];
                    console.log('draw note',drawNote);
                    var remark_sentence_json_str = JSON.stringify(drawNote.remark_sentence_json);
                    var sentence_json = JSON.parse(remark_sentence_json_str);
                    if (typeof sentence_json == 'string') {
                        sentence_json = JSON.parse(sentence_json);
                    }
                    if (sentence_json) {
                        try {
                            helper.setSelection( drawNote.remark_sentence, sentence_json.start_paths ,sentence_json.start, sentence_json.end_paths, sentence_json.end, drawNote.id,drawNote.remark_text.length > 0);
                        }catch (e) {
                            console.log('draw fail note',drawNote.remark_sentence,drawNote.id,e);
                            return e;
                        }
                    }
                }
            }
        },
        cleanAllNotes: function() {
            var notesID = _drawLineRecords.map(function (note) {
                return note.id;
            });
            for (var noteID of notesID) {
                var removeNote = helper.cleanNote(noteID);
                // console.log('removeNote:',removeNote);
            }
            $("div[class*='dots-group']").remove();

            var rootChildNodes = $('.course-content')[0].childNodes;
            for (var childNode of rootChildNodes) {
                childNode.normalize();
            }

        },

        setSelection: function (str, start_paths,start_offset, end_paths,end_offset, id,with_dot=false) {
            console.log(start_paths,start_offset,end_paths,end_offset,id);
            var start_node = this.getPathToNode(start_paths);
            var end_node = this.getPathToNode(end_paths);
            console.log(start_node,end_node);
            if (start_node && end_node) {
                console.log(start_node.firstChild,end_node.firstChild);
                var range = document.createRange();
                var selection = window.getSelection();
                range.setStart(start_node.firstChild ? start_node.firstChild : start_node, (start_node.nodeName == 'BR') ? 0 : start_offset);
                range.setEnd(end_node.firstChild ? end_node.firstChild : end_node, (end_node.nodeName == 'BR') ? 0 : end_offset);
                selection.removeAllRanges();
                selection.addRange(range);
                var rect = range.getBoundingClientRect();
                var dotsOffset = rect.top + rect.height/2 - 10;
                document.designMode = "on";
                document.execCommand('Underline', false);
                var uEles = $( "u" ).not('[class]').addClass('note-'+id);
                var middleItem = uEles[Math.round((uEles.length - 1) / 2)];
                var middleItemStype = window.getComputedStyle(middleItem);
                var line = Math.round(middleItem.offsetHeight / parseFloat(middleItemStype.lineHeight));
                console.log('middleItem: ',uEles,middleItem,middleItem.offsetHeight,middleItemStype.lineHeight,line,dotsOffset);
                console.log('_rect_',rect,dotsOffset);
                if (with_dot) {
                    var dots = document.createElement('div');
                    dots.innerHTML = '●<br/>';
                    dots.setAttribute('style', 'position: absolute;' +
                        'right: 2px;' +
                        'color: rgba(240,221,113, 1);' +
                        'top: ' + dotsOffset + 'px;' +
                        'height: 10px;' +
                        'font-size: 12px;'
                    );
                    dots.setAttribute('class','dots-'+id);
                    dots.id = 'dots-'+id;
                    document.querySelector('body').appendChild(dots);
                }

                var fnClick = function(e){
                    console.log(e);
                    var alertId = 'note-' + id;
                    console.log(alertId);
                    return alertId;
                };

                uEles.on('click',fnClick);
                if (with_dot) {
                    dots.addEventListener('click', fnClick);
                }
                selection.removeAllRanges();
                document.designMode = "off";
            }
        },
    };

            

    window.onload=function() {
        var zoom = 'small';
        if(deviceType == 'android'){
            if (zoom == 'big') {
                zoom = 1.2;
            }else if(zoom == 'small') {
                zoom = 0.8;
            }else {
                zoom = 1;
            }
        }else{
            zoom = 1
        }
        // console.log('window load',helper.getPageHeight(),helper.getPageWeight());
        if ((typeof jsbridge) != 'undefined') {
            if (typeof (jsbridge.pageLayout) == "function") {
                jsbridge.pageLayout(helper.getPageHeight(), helper.getPageWeight());
            }
            if (link_note_position && link_note_position!=0 && typeof (jsbridge.pageSetPosition) == "function") {
                console.log("pageSetPosition:::::::",link_note_position)
                jsbridge.pageSetPosition(link_note_position,helper.getPageWeight(),zoom);
            }
        }
    }

    $(document).ready(function(){
        // var _pageSize = helper.getPageSize()
        // 将引用模块转换为金句的形式
        var blockquotes = document.getElementsByTagName("blockquote");
        for (var i = 0; i < blockquotes.length; i++) {
            var blockquote = blockquotes[i];
            var valueDiv = blockquote.querySelector(".blockquote-value");
            if (valueDiv) {
                var valueSpan = document.createElement("span");
                valueSpan.className = "gold_line " + valueDiv.className;
                valueSpan.innerHTML = valueDiv.innerHTML;
                valueDiv.parentNode.replaceChild(valueSpan, valueDiv);
            }
            var fromDiv = blockquote.querySelector(".blockquote-from");

            if (fromDiv && valueSpan) {
                valueSpan.appendChild(fromDiv);
            }
        }
        // 页面加载完成后向原生发送页面信息
        pageLoadFinish();
        var s = helper.getContentInfo();
        // console.log('document ready s: ',s);
        var gold_line_is_chosen = "0"
        var gold_line_text = ""
        

        // 复制行为
        var copyBtn = $('div.btn-group > div.copy')[0];
        function copyAction(e) {
            var noteID = e.target.value;
            var copyStr = '';
            if (noteID) {
                var note = getNote(noteID);
                if (note) {
                    copyStr = note.remark_sentence;
                }
            }else {
                copyStr = getSelection().toString();
            }
            console.log('复制:',copyStr);
            if ((typeof jsbridge) != 'undefined') {
                if (typeof(jsbridge.copyString) == "function")
                {
                    jsbridge.copyString(copyStr);
                }
            }
            // hideMenu();
        }
        copyBtn.addEventListener('touchstart',function (e) {
            $('img').not('.note').css('pointer-events','none');
            setTimeout(function(){ $('img').not('.note').css('pointer-events','all')},350)
            copyAction(e);
            e.stopPropagation();
        },false);


        // 分享
        var shareBtn = $('div.btn-group > div.share')[0];
        shareBtn.addEventListener('touchstart',function (e) {
            $('img').not('.note').css('pointer-events','none');
            setTimeout(function(){ $('img').not('.note').css('pointer-events','all')},350)
            var noteID = shareBtn.value || "";
            var shareStr = '';
            if (noteID) {
                var note = getNote(noteID);
                if  (note) {
                    shareStr = note.remark_sentence;
                }
            }else {
                shareStr = getSelection().toString();
            }
            if ((typeof jsbridge) != 'undefined') {
                // if (typeof(jsbridge.shareNoteReport) == "function")
                // {
                //     console.log("shareNoteReport",content_id,article_id);
                //     let arr = [noteID,shareStr,content_id,article_id];
                //     // console.log('shareNoteReport',noteID,typeof shareStr,typeof content_id,typeof article_id);
                //     jsbridge.shareNoteReport(arr);
                //     // jsbridge.shareNote(noteID,shareStr);
                // } 
                 if (typeof(jsbridge.shareNoteContent) == "function"){
                    let shareType = gold_line_is_chosen == "1"?"1":"0"
                    shareNoteContent(noteID,shareStr,shareType)
                }
                else if (typeof(jsbridge.shareNote) == "function"){
                    console.log('shareNote');
                    let shareType = gold_line_is_chosen == "1"?"1":"0"
                    if(version410){
                        shareNoteContent(noteID,shareStr,shareType)
                    }else{
                        if(deviceType == 'android'){
                            jsbridge.shareNote(noteID,shareStr);
                        }else{
                            jsbridge.shareNote(noteID,shareStr,shareType);
                        }
                    }
                }
            }
            // hideMenu();
            e.stopPropagation()
        },false);

        //点击图片
        $('img').not('.note').on('click',function () {
            let images = document.querySelectorAll('img');
            let imageSources = [];
            let imgIndex = 0
            images.forEach((img,index) => {
                let classes = img.getAttribute('class');
                if (!classes || !classes.includes('note')) {
                    let src = img.getAttribute('src');
                    if (src) {
                        imageSources.push(src);
                    }
                }
            });
            imageSources.forEach((img,index) => {
                if (img && $(this).attr('src') == img) {
                    imgIndex = index
                }
            })
            imageSources = imageSources.join(",")
            console.log(imageSources,imgIndex);
            var pTagName = $(this).parents()[0].tagName;
            if(pTagName !== 'A') {
                var src = $(this).attr('src');
                if (src) {
                    clickImage(imgIndex,imageSources,$(this).attr('src'));
                }
            }
        });

        //点击注释
        $('img.note').on('click',function () {
            var ref = $(this).data('ref');
            var note = $(this).data('note');
            if(ref){
              ref = ref.toString()
            }
            if(note){
                note = note.toString()
            }
            if(ref && ref.length){
                clickAnnotation(note,ref);
            }else{
                clickAnnotation(note, '');
            }
        });

        // 4.1.0笔记功能(交互) start----------------------------------------------------------
        // 笔记，划线的点击方法
        
        $('.course-content').on('click', '.note-unit', function (e) {
            // 判断父节点是否是 <a> 标签，a标签点击优先级更高
            if ($(this).parent().is('a')) {
                return
            }

            var noteId = $(this).attr('data-noteid');
            if(!noteId){
                return
            }
            var noteType = $(this).attr('data-notetype');
            var noteContent = $(this).attr('data-notecontent');
            noteId = noteId.toString()
            if(noteContent){
                noteContent = noteContent.toString()
            }
            let note_item = getNoteData(noteId)
            // 点击笔记
            if(noteContent){
                let app_scheme = 'vistopia://article-note-detail?noteId='+noteId
                location.href = app_scheme
            //点击摘录
            }else{
                if (document.selection) {
                    window.getSelection().removeAllRanges();
                } else if (window.getSelection) {
                    note_chosen_data_click={
                        showType : 2,
                        remark_index:note_item.remark_index,
                        remark_text:note_item.remark_text,
                        note_id : note_item.note_id,
                        note_content:"",
                        del_note_ids:"",
                        type: "2"
                    }
                    console.log("note_chosen_data_click:",note_chosen_data_click)
                    // 选中整段摘录的文字
                    var selection = window.getSelection();
                    var range = document.createRange();
                    var targetElements = document.querySelectorAll('[data-noteid="'+noteId+'"]');
                    if(targetElements.length>1){
                        // 获取要选择的相邻节点
                        var node1 = targetElements[0];
                        var node2 = targetElements[targetElements.length-1];
                        // 选择节点范围
                        range.setStartBefore(node1);
                        range.setEndAfter(node2);
                    }else{
                        range.selectNode(targetElements[0]);
                    }
                    // 清空之前的选中范围，然后添加新的范围
                    selection.removeAllRanges();
                    selection.addRange(range);
                    console.log("selection:",selection)                   
                }
                note_is_chosen = "1";
                e.stopPropagation();
            }
        });
        // 写笔记/编辑笔记，拉起端的弹窗
        var noteBtn = document.querySelectorAll("div.btn-group > div.btn-note");
        for (let i = 0; i < noteBtn.length; i++) {
            noteBtn[i].addEventListener('touchstart',function (e) {
                let noteInfo = {
                    type: note_chosen_data.type.toString(), //1:新增笔记  2:修改笔记
                    del_note_ids: note_chosen_data.del_note_ids.toString(), //多个ID 用逗号分隔，包括笔记id、划线id，没有时传空
                    note_id: note_chosen_data.note_id.toString(), //笔记id，如果是新增笔记，值为空
                    remark_text: note_chosen_data.remark_text.toString(), //文稿被选中的内容
                    remark_index: note_chosen_data.remark_index.toString(), //文稿被选中的索引
                    note_content: note_chosen_data.note_content.toString(), //笔记内容，没有时传空
                    content_id: note_chosen_data.content_id.toString(), //节目id
                    article_id: note_chosen_data.article_id.toString(), //小节id
                    article_title:note_chosen_data.article_title.toString(),
                    content_title:note_chosen_data.content_title.toString(),
                    author:note_chosen_data.author.toString(),
                    image:note_chosen_data.image.toString()
                };
                // console.log("noteInfo:",noteInfo)
                let d = JSON.stringify(noteInfo);
                d = new TextEncoder().encode(d)
                d = btoa(String.fromCharCode.apply(null,d))
                let noteURL = "vistopia://webNote?note_info=" + encodeURIComponent(d);
                let messagingIframe = document.createElement("iframe");
                messagingIframe.style.display = "none";
                document.documentElement.appendChild(messagingIframe);
                //触发scheme
                messagingIframe.src = noteURL;
                // hideMenu();//hideMenu会导致击穿
                e.stopPropagation()
            },false);
        }

        var excerptBtn = document.querySelectorAll("div.btn-group > div.excerpt");
        excerptBtn[0].addEventListener('touchstart',function (e) {
            
            noteAddInterface()
            // hideMenu();
            e.stopPropagation()
        })
        var cancelExcerptBtn = document.querySelectorAll("div.btn-group > div.cancel-excerpt");
        cancelExcerptBtn[0].addEventListener('touchstart',function (e) {
            noteDelInterface()
            // hideMenu();
            e.stopPropagation()
        })

        // 笔记交互功能 end------------------------------------------------------------------


       
        // 点击金句
        var gold_line_list = document.querySelectorAll(".gold_line");

        for (let i = 0; i < gold_line_list.length; i++) {
            gold_line_list[i].addEventListener("click", function (e) {
                if(hasChildNoteUnit(gold_line_list[i])){
                    return
                }
                var oRect = gold_line_list[i].getBoundingClientRect();
                if (document.selection) {
                    window.getSelection().removeAllRanges();
                } else if (window.getSelection) {
                    window.getSelection().selectAllChildren(gold_line_list[i]);
                    // console.log('aaa',window.getSelection());
                }
                gold_line_is_chosen = "1"
                gold_line_text = getSelection().toString()
                console.log("初始赋值:",gold_line_text)
                e.stopPropagation();
            })
        }

        var temp_selection_str = '';
        var selection_should_disappear = 'disappear'; //如果old长度大于0，new长度为0
        var selection_should_appear = 'appear'; //如果old长度为0，new大于0
        var selection_change = 'change';  //如果old、new都大于0，且不相等
        function getActionFrom(new_selection_str) {
            if (temp_selection_str.length > 0 && new_selection_str.length == 0) {
                temp_selection_str = new_selection_str;
                return selection_should_disappear;
            }else if(temp_selection_str.length == 0 && new_selection_str.length > 0) {
                temp_selection_str = new_selection_str;
                return selection_should_appear;
            }else if(temp_selection_str.length > 0 && new_selection_str.length > 0 && temp_selection_str != new_selection_str) {
                temp_selection_str = new_selection_str;
                return selection_change;
            }
            return '';
        }

        // 点击音频时间戳
        const timestamp = document.querySelectorAll(".timestamp");
        for (let i = 0; i < timestamp.length; i++) {
            timestamp[i].addEventListener("click", function (e) {
                let times = this.getAttribute("data-time");
                console.log("times",times);
                if ((typeof jsbridge) != 'undefined') {
                    if (typeof (jsbridge.getTimeSlot) == "function") {
                        console.log("getTimeSlot",jsbridge.getTimeSlot)
                        jsbridge.getTimeSlot(times,content_id,article_id);
                    }
                }
                e.stopPropagation();
            })
        }
    
        document.addEventListener("selectionchange", function(e) {
            var selection = window.getSelection();
            // if(prohibit) return;
            var selectionRange = null;
            var oRect = null;
            var top = null;
            let dom = document.querySelector("#questionMarkId");
            if (getSelection().toString()) {
                selectionRange = getSelection().getRangeAt(0);
                oRect = selectionRange.getBoundingClientRect();
                
                let recTop = 0
                let show_top = true
                

                 // 获取选中文本的首字符的矩形信息
                var startRect = selectionRange.startContainer.nodeType === 3
                    ? selectionRange.startContainer.parentElement.getBoundingClientRect()
                    : selectionRange.startContainer.getBoundingClientRect();

                // 获取首字符所在节点的Y坐标
                var startY = startRect.top;
                if(startY){
                    startY = parseFloat(startRect.top)
                }

                // console.log('Start Character Y:', startY);

                // 获取选中范围的矩形信息
                var rects = selectionRange.getClientRects();
                // 获取光标最后停留的位置
                if (rects.length > 0) {
                    recTop = rects[rects.length - 1].top;

                    // console.log('Last Cursor Position Y:', recTop);
                }
                if(recTop){
                    recTop = parseFloat(recTop)
                }
                let screenHeight = 0
            
                if(startY<=190){
                    show_top = false
                }else{
                    // if(selection_cursor_s != startY && selection_cursor_e == recTop){
                    //     show_top = true
                    // }else if(selection_cursor_s == startY && selection_cursor_e != recTop){
                    //     show_top = false
                    // }else{
                        show_top = true
                    // }
                    
                }
                // if(selection_cursor_s != startY && selection_cursor_e != recTop && (selection_cursor_s !=0 || selection_cursor_e!=0)){

                // }else{
                //     selection_cursor_s = startY
                //     selection_cursor_e = recTop
                // }
                
                // console.log("show_top::::",show_top)

                 // 获取选中文本的起始点和结束点的坐标
                // var startRect = selectionRange.startContainer.getBoundingClientRect();
                // var endRect = selectionRange.endContainer.getBoundingClientRect();

                // console.log('Start Point X:', startRect.left);
                // console.log('Start Point Y:', startRect.top);
                // console.log('End Point X:', endRect.right);
                // console.log('End Point Y:', endRect.bottom);
                // console.log('oRect',oRect);
                if(!show_top) {
                    dom.classList.add("icon_top");
                    dom.classList.remove("icon_bottom");
                    top = oRect.top +  oRect.height + 130;
                }else {
                    dom.classList.add("icon_bottom");
                    dom.classList.remove("icon_top");
                    top=oRect.top;
                }
                var cont_width = document.querySelector(".course-content").offsetWidth || null;
                var cont_left = document.querySelector(".course-content").offsetLeft || null;
                // offsetLeft = parseInt(oRect.left,10) > 60 ? parseInt(oRect.left,10) : offsetLeft;
                if(version410){
                    if(deviceType == 'android'){
                        if(cont_width && offsetLeft>cont_width-170) {
                            offsetLeft = cont_width-170;
                        }
                    }else{
                        if(cont_width && offsetLeft>cont_width-150) {
                            offsetLeft = cont_width-150;
                        }
                    }
                }else{
                    if(deviceType == 'android'){
                        if(cont_width && offsetLeft>cont_width) {
                            offsetLeft = cont_width-10;
                        }
                    }else{
                        if(cont_width && offsetLeft>cont_width-60) {
                            offsetLeft = cont_width-60;
                        }
                    }
                }
                
                // console.log("offsetLeft",offsetLeft,"cont_width",cont_width,"cont_left",cont_left)
            }
            var selection_str = getSelection().toString();
            var selection_action = getActionFrom(selection_str);
            if (selection_action == 'disappear') {
                //取消焦点
                console.log('should disappear');
                gold_line_is_chosen = "0" //将金句选中标识置为“0”
                gold_line_text = ""
                note_is_chosen = "0"
                note_chosen_data = null;
                hideMenu();
            }else if(selection_action == 'change') {
                // var noteID = shareBtn.value || "";
                var shareStr = '';
                // if (noteID) {
                //     var note = getNote(noteID);
                //     if  (note) {
                //         shareStr = note.remark_sentence;
                //     }
                // }else {
                    shareStr = getSelection().toString();
                // }
                //选中文字变更中且大于0
                // if ((typeof jsbridge) != 'undefined') {
                //     if (typeof(jsbridge.onFocusedChange) == "function")
                //     {
                //         jsbridge.onFocusedChange(shareStr);
                //     }
                // }
                if(selection_str != gold_line_text){
                    gold_line_text = ""
                    gold_line_is_chosen = "0"
                }


                showMenuLater(top, offsetLeft);
                // console.log('onFocusedChange.',selection_str);
                
            }else if(selection_action == 'appear') {
                // var noteID = shareBtn.value || "";
                var shareStr = '';
                // if (noteID) {
                //     var note = getNote(noteID);
                //     if  (note) {
                //         shareStr = note.remark_sentence;
                //     }
                // }else {
                    shareStr = getSelection().toString();
                // }
                //应该出现自定义弹窗
                if ((typeof jsbridge) != 'undefined') {
                    if (typeof(jsbridge.onFocused) == "function")
                    {
                        jsbridge.onFocused(shareStr);
                    }
                }

                showMenu(top,offsetLeft);
                // console.log('onFocused.',selection_str);
            }else {
                console.log('not found action:',selection_action);
            }
        });


        //记录上一个touch事件的类型，touchend或者touchcancel清空
        var _touchtype_log = '';
        $(document).on('touchend',function (e) {
            var selection = getSelection();
            var selection_str = selection.toString();
            var selectionRange = null;
            var oRect = null;
            if (selection.rangeCount > 0) {
                selectionRange = selection.getRangeAt(0);
                oRect = selectionRange.getBoundingClientRect();
            }

            if (_touchtype_log == 'touchstart') {
                if (selection_str.length > 0 ) {
                    if ((typeof jsbridge) != 'undefined') {
                        if (typeof(jsbridge.onFocusCancel) == "function")
                        {
                            jsbridge.onFocusCancel('cancel');
                        }
                    }
                    // console.log("rangeCount",selection.rangeCount);
                    // console.log("_touchtype_log",_touchtype_log);
                    if(selection.rangeCount <= 0) {
                        hideMenu();
                        console.log('touchend onFocusCancel.');
                    }

                }
            }else if(_touchtype_log == 'touchmove') {
                // var noteID = shareBtn.value || "";
                var shareStr = '';
                // if (noteID) {
                //     var note = getNote(noteID);
                //     if  (note) {
                //         shareStr = note.remark_sentence;
                //     }
                // }else {
                    shareStr = getSelection().toString();
                // }
                if (selection_str.length > 0 ) {
                    if ((typeof jsbridge) != 'undefined') {
                        if (typeof(jsbridge.onFocusedChange) == "function")
                        {
                            jsbridge.onFocusedChange(shareStr);
                        }
                    }
                    // console.log('touchend onFocusedChange.',selection_str);
                }
            }else {
                console.log('touchend');
            }
            
            _touchtype_log = '';
        });
        $(document).on('touchmove',function (e) {
            // console.log('touchmove',e.type);
            _touchtype_log = e.type;
        });
        $(document).on('touchcancel',function (e) {
            console.log('touchcancel',e.type);
            _touchtype_log = '';
        });
        $(document).on('touchstart',function(e) {
            var originalEvent = e.originalEvent;

            // 检查 e.touches 是否存在
            if (originalEvent.touches && originalEvent.touches.length > 0) {
                var touch = originalEvent.touches[0];
                // 继续处理触摸事件
            } else {
                // 非触摸设备上的处理逻辑
                console.log('eeeeeeee')
                return
            }
            offsetLeft = touch.screenX;
            // offsetLeft = parseInt(touch.left,10) > 60 ? parseInt(oRect.left,10) : offsetLeft;
            // var x = Number(touch.pageX);
            if (e.target.nodeName == 'U') {
                //点击笔记
                var offset = $(e.target).offset();
                console.log('点击笔记',e.target.className,offset);
                showMenu(offset.top, offset.left, e.target.className.substring(5));
            }else {
                //点击不是笔记就隐藏笔记Menu
                // console.log('笔记menu：',_isNoteMenuVisable);
                if (_isNoteMenuVisable) {
                    // hideMenu();
                }
                if (_isPopverMenuVisable) {
                    hiddenPopover();
                }
            }
            _touchtype_log = e.type;
        });
    });
</script>
</body>
</html>
